<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cobertura de Testes Apex — Visualizador</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151821; --muted:#9aa4b2; --text:#e8ecf1; --accent:#4aa3ff; --danger:#ff5b5b;
      --ok:#2fd47a; --border:#242939;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-size:18px;margin:12px 0}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr 2fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 20px rgba(0,0,0,.25)}
    .card header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
    .card header h2{margin:0;font-size:15px}
    .card .body{padding:12px 14px}
    textarea{width:100%;min-height:220px;resize:vertical;background:#0b0d12;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
    input[type="text"]{flex:1 1 220px;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#0b0d12;color:var(--text)}
    button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#101626;color:var(--text);cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1a66ff,#1247b8);border-color:#0f2f7a}
    button.ghost{background:#101318}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:6px 10px}
    tbody tr{background:#0b0f18;border:1px solid var(--border);transition:transform .06s ease}
    tbody tr:hover{transform:translateY(-1px)}
    td{padding:10px}
    .num{font-variant-numeric:tabular-nums;text-align:right}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#0f1320}
    .pct-ok .badge{background:rgba(47,212,122,.12);border-color:rgba(47,212,122,.35);color:var(--ok)}
    .pct-bad{outline:1px solid rgba(255,91,91,.35);background:linear-gradient(180deg,rgba(255,91,91,.08),transparent)}
    .pct-bad .badge{background:rgba(255,91,91,.12);border-color:rgba(255,91,91,.35);color:var(--danger)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .sticky{position:sticky;top:0;background:var(--panel);z-index:2;border-bottom:1px solid var(--border)}
    .small{font-size:12px}
    .checkbox{width:18px;height:18px}
    .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b0f18}
    .totals{display:flex;gap:10px;flex-wrap:wrap}
    .totals .pill strong{color:var(--accent)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .footer-note{margin-top:8px;color:var(--muted);font-size:12px}
    code.k{background:#0b0f18;border:1px solid var(--border);padding:1px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Cobertura de Testes Apex</h1>

    <div class="grid">
      <!-- Painel de entrada -->
      <section class="card">
        <header><h2>Entrada de dados (JSON)</h2></header>
        <div class="body">
          <div class="row">
            <button id="btnLoad" class="primary">Carregar JSON</button>
            <button id="btnSample" class="ghost">Exemplo</button>
            <span class="muted small">Campos esperados: <code class="k">ApexClassOrTrigger.Name</code>, <code class="k">NumLinesCovered</code>, <code class="k">NumLinesUncovered</code></span>
          </div>
          <textarea id="inputJson" placeholder='
Faca o Select na tabela de cobertura do Salesforce:
[
    SELECT ApexClassOrTrigger.Name, NumLinesCovered, NumLinesUncovered FROM ApexCodeCoverageAggregate ORDER BY ApexClassOrTrigger.Name ASC
]          
!Nao esqueca de selecionar o Tooling API antes de executar o query.          
Cole aqui um JSON como:
[
  {"ApexClassOrTrigger.Name":"AccountTrigger","NumLinesCovered":5,"NumLinesUncovered":1},
  {"ApexClassOrTrigger.Name":"ATL_Utils","NumLinesCovered":92,"NumLinesUncovered":446}
]'></textarea>
          <div id="err" class="hint"></div>
        </div>
      </section>

      <!-- Painel geral -->
      <section class="card">
        <header class="sticky">
          <h2 style="flex:1">Tabela geral</h2>
          <div class="toolbar">
            <input type="text" id="search" placeholder="Pesquisar por nome..." />
            <button id="selectVisible" class="ghost">Selecionar visíveis</button>
            <button id="clearSelection" class="ghost">Limpar seleção</button>
          </div>
        </header>
        <div class="body">
          <div class="totals" id="totals"></div>
          <table id="mainTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="checkAll" class="checkbox" title="Selecionar tudo"/></th>
                <th>Classe/Trigger</th>
                <th class="num">Cobertas</th>
                <th class="num">Descobertas</th>
                <th class="num">% Coberta</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="footer-note">Linhas com cobertura abaixo de 80% ficam destacadas em vermelho. Clique nas caixas para enviar itens à tabela refinada.</div>
        </div>
      </section>
    </div>

    <!-- Painel refinado -->
    <section class="card" style="margin-top:16px">
      <header>
        <h2 style="flex:1">Tabela refinada (selecionados)</h2>
        <div class="toolbar">
          <button id="exportCsv" class="ghost">Exportar CSV</button>
          <span id="refinedTotals" class="muted small"></span>
        </div>
      </header>
      <div class="body">
        <table id="refinedTable">
          <thead>
            <tr>
              <th>Classe/Trigger</th>
              <th class="num">Cobertas</th>
              <th class="num">Descobertas</th>
              <th class="num">% Coberta</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>

  <script>
    // Estado
    let rows = [];          // dados normalizados
    let filteredIdx = [];   // índices atuais após filtro
    let selected = new Set();

    const $ = sel => document.querySelector(sel);
    const mainBody = $('#mainTable tbody');
    const refinedBody = $('#refinedTable tbody');
    const err = $('#err');

    function normalize(input){
      // aceita: array de objetos; ou string TSV; mas aqui focamos em JSON
      return input.map(item=>{
        // suporta chave com ponto
        const name = item["ApexClassOrTrigger.Name"] ?? item.ApexClassOrTrigger?.Name ?? item.Name ?? "";
        const covered = toInt(item.NumLinesCovered);
        const uncovered = toInt(item.NumLinesUncovered);
        const total = covered + uncovered;
        const pct = total > 0 ? (covered/total)*100 : 0;
        return { name, covered, uncovered, total, pct };
      }).filter(x => x.name !== "");
    }
    function toInt(v){ const n = Number(v); return Number.isFinite(n) ? Math.max(0, Math.trunc(n)) : 0; }

    function renderTable(){
      mainBody.innerHTML = '';
      const term = $('#search').value.trim().toLowerCase();
      filteredIdx = [];
      rows.forEach((r, i)=>{
        if(term && !r.name.toLowerCase().includes(term)) return;

        filteredIdx.push(i);
        const tr = document.createElement('tr');
        tr.className = r.pct < 80 ? 'pct-bad' : 'pct-ok';

        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.className = 'checkbox';
        cb.checked = selected.has(i);
        cb.addEventListener('change', ()=>{
          if(cb.checked) selected.add(i); else selected.delete(i);
          renderRefined();
        });

        tr.innerHTML = `
          <td></td>
          <td>${escapeHtml(r.name)}</td>
          <td class="num">${r.covered}</td>
          <td class="num">${r.uncovered}</td>
          <td class="num"><span class="badge">${r.pct.toFixed(2)}%</span></td>
        `;
        tr.firstElementChild.appendChild(cb);
        mainBody.appendChild(tr);
      });

      // totais gerais
      const totals = sum(rows);
      $('#totals').innerHTML = `
        <span class="pill">Total linhas: <strong>${totals.total}</strong></span>
        <span class="pill">Cobertas: <strong>${totals.covered}</strong></span>
        <span class="pill">Descobertas: <strong>${totals.uncovered}</strong></span>
        <span class="pill">% Geral: <strong>${totals.pct.toFixed(2)}%</strong></span>
        <span class="pill">Itens: <strong>${rows.length}</strong></span>
      `;
      $('#checkAll').checked = filteredIdx.every(i => selected.has(i)) && filteredIdx.length>0;
      renderRefined();
    }

    function renderRefined(){
      refinedBody.innerHTML = '';
      const chosen = [...selected].map(i => rows[i]);
      chosen.forEach(r=>{
        const tr = document.createElement('tr');
        tr.className = r.pct < 80 ? 'pct-bad' : 'pct-ok';
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <td class="num">${r.covered}</td>
          <td class="num">${r.uncovered}</td>
          <td class="num"><span class="badge">${r.pct.toFixed(2)}%</span></td>
        `;
        refinedBody.appendChild(tr);
      });
      const totals = sum(chosen);
      $('#refinedTotals').textContent =
        chosen.length ? `Selecionados: ${chosen.length} • % média: ${totals.pct.toFixed(2)}%` : 'Nada selecionado';
    }

    function sum(list){
      const covered = list.reduce((a,b)=>a+b.covered,0);
      const uncovered = list.reduce((a,b)=>a+b.uncovered,0);
      const total = covered + uncovered;
      const pct = total>0 ? (covered/total)*100 : 0;
      return {covered, uncovered, total, pct};
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Eventos
    $('#btnLoad').addEventListener('click', ()=>{
      err.textContent = '';
      selected.clear();
      try{
        const txt = $('#inputJson').value.trim();
        if(!txt) throw new Error('Informe um JSON válido.');
        const data = JSON.parse(txt);
        if(!Array.isArray(data)) throw new Error('O JSON deve ser um array de objetos.');
        rows = normalize(data);
        if(!rows.length) throw new Error('Nenhum registro com nome válido foi encontrado.');
        renderTable();
      }catch(e){
        rows = [];
        mainBody.innerHTML = '';
        refinedBody.innerHTML = '';
        $('#totals').innerHTML = '';
        $('#refinedTotals').textContent = '';
        err.textContent = 'Erro: ' + e.message;
      }
    });

    $('#btnSample').addEventListener('click', ()=>{
      const sample = [
        {"ApexClassOrTrigger.Name":"AccountTrigger","NumLinesCovered":5,"NumLinesUncovered":1},
        {"ApexClassOrTrigger.Name":"ATL_AvayaConnectorController","NumLinesCovered":137,"NumLinesUncovered":16},
        {"ApexClassOrTrigger.Name":"ATL_AutosservicoGetInvalidAsset","NumLinesCovered":31,"NumLinesUncovered":11},
        {"ApexClassOrTrigger.Name":"ATL_Utils","NumLinesCovered":92,"NumLinesUncovered":446},
        {"ApexClassOrTrigger.Name":"BusinessHoursUtil","NumLinesCovered":39,"NumLinesUncovered":1},
        {"ApexClassOrTrigger.Name":"TriggerHandler","NumLinesCovered":44,"NumLinesUncovered":59}
      ];
      $('#inputJson').value = JSON.stringify(sample, null, 2);
    });

    $('#search').addEventListener('input', renderTable);

    $('#checkAll').addEventListener('change', (e)=>{
      const mark = e.target.checked;
      filteredIdx.forEach(i => mark ? selected.add(i) : selected.delete(i));
      renderTable();
    });

    $('#selectVisible').addEventListener('click', ()=>{
      filteredIdx.forEach(i => selected.add(i));
      renderRefined();
      // mantém o estado do "select all"
      $('#checkAll').checked = filteredIdx.length>0;
    });

    $('#clearSelection').addEventListener('click', ()=>{
      selected.clear();
      renderTable();
    });

    $('#exportCsv').addEventListener('click', ()=>{
      const chosen = [...selected].map(i=>rows[i]);
      if(!chosen.length){ alert('Nada selecionado.'); return; }
      const header = ['Name','NumLinesCovered','NumLinesUncovered','PercentCovered'];
      const lines = [header.join(',')].concat(chosen.map(r=>[
        `"${r.name.replace(/"/g,'""')}"`, r.covered, r.uncovered, r.pct.toFixed(2)
      ].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'refined_coverage.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
