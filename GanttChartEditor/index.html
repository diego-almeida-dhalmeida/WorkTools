<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>App</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 16 16%27%3E%3Ctext y=%2712%27 font-size=%2712%27%3E⚙%3C/text%3E%3C/svg%3E">
  <script src="../assets/js/app.js" defer></script>
</head>
<body>
  <main>
    
    <section id="content">
<div class="topbar">
  <div class="subtitle" data-i18n="title_portal">Aplicativos Diversos</div>
  <div class="actions">
    <div class="lang-toggle">
      <button data-lang="en" onclick="setLanguage('en')" class="active" data-i18n="lang_en">English</button>
      <button data-lang="pt" onclick="setLanguage('pt')" data-i18n="lang_pt">Português</button>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()"><span class="icon"></span><span data-i18n="theme_dark">Dark</span></button>
  </div>
</div>

<div class="container">
  <h1class="bg-primary text-white p-3 rounded" data-i18n="ganttcharteditor_editor_gantt_com_tons_past_is">Editor Gantt com Tons Pastéis</h1>

  <div class="card mt-4 shadow-sm">
  <div class="card-header bg-primary text-white">
    Gerenciar Planejamento <span id="cancelarEdicao" style="display:none; cursor:pointer; float:right; font-weight:normal;" onclick="limpar()">❌</span>
  </div>
  <div class="card-body">
    <form id="formulario" class="row g-3">
    <div class="col-md-6">
      <labelclass="form-label" data-i18n="ganttcharteditor_descri_o">Descrição</label>
      <input type="text" id="descricao" class="form-control">
    </div>
    <div class="col-md-3">
      <labelclass="form-label" data-i18n="ganttcharteditor_62037d4390">Cor</label>
      <select id="cor" class="form-select"></select>
    </div>
    <div class="col-md-3">
      <labelclass="form-label" data-i18n="ganttcharteditor_per_odos">Períodos</label>
      <select id="periodos" class="form-select">
        <optionvalue="1" data-i18n="ganttcharteditor_1_per_odo_s">1 período(s)</option><optionvalue="2" data-i18n="ganttcharteditor_2_per_odo_s">2 período(s)</option><optionvalue="3" data-i18n="ganttcharteditor_3_per_odo_s">3 período(s)</option><optionvalue="4" data-i18n="ganttcharteditor_4_per_odo_s">4 período(s)</option><optionvalue="5" data-i18n="ganttcharteditor_5_per_odo_s">5 período(s)</option><optionvalue="6" data-i18n="ganttcharteditor_6_per_odo_s">6 período(s)</option><optionvalue="7" data-i18n="ganttcharteditor_7_per_odo_s">7 período(s)</option><optionvalue="8" data-i18n="ganttcharteditor_8_per_odo_s">8 período(s)</option><optionvalue="9" data-i18n="ganttcharteditor_9_per_odo_s">9 período(s)</option>
      </select>
    </div>
    <div class="col-md-3">
      <labelclass="form-label" data-i18n="ganttcharteditor_in_cio_do_projeto">Início do Projeto</label>
      <input type="date" id="inicio" class="form-control" value="2025-07-30">
    </div>
    <div class="col-12">
      <buttontype="button" class="btn btn-success" onclick="incluirTarefa()" data-i18n="ganttcharteditor_incluir">Incluir</button>
      <buttontype="button" class="btn btn-warning" onclick="editarTarefa()" data-i18n="ganttcharteditor_editar">Editar</button>
      <buttontype="button" class="btn btn-danger" onclick="excluirTarefa()" data-i18n="ganttcharteditor_excluir">Excluir</button>
      <buttontype="button" class="btn btn-secondary" onclick="exportarJSON()" data-i18n="ganttcharteditor_exportar_json">Exportar JSON</button>
      <label class="btn btn-secondary mb-0">
        Importar JSON <input type="file" id="importarJson" style="display:none" onchange="importarJSON(event)">
      </label>
    </div>
  </form>

  </form>
  </div>
</div>
<hr class="my-4">

  <table class="table table-bordered text-center align-middle">
    <thead id="gantt-head"></thead>
    <tbody id="gantt-body"></tbody>
  </table>
</div>

<script>
let tarefas = [];
let dias = [];
let tarefaSelecionada = null;
  document.querySelector('button[onclick="incluirTarefa()"]').style.display = "inline-block";
  document.getElementById("cancelarEdicao").style.display = "none";
  document.querySelector('button[onclick="editarTarefa()"]').style.display = "none";
  document.querySelector('button[onclick="excluirTarefa()"]').style.display = "none";
let coresDisponiveis = [
  {
    "nome": "Vermelho Pastel",
    "valor": "#FFB3B3"
  },
  {
    "nome": "Verde Pastel",
    "valor": "#B3FFB3"
  },
  {
    "nome": "Azul Pastel",
    "valor": "#B3D1FF"
  },
  {
    "nome": "Rosa Pastel",
    "valor": "#FFCCE5"
  },
  {
    "nome": "Ciano Pastel",
    "valor": "#CCFFFF"
  },
  {
    "nome": "Roxo Pastel",
    "valor": "#E0CCFF"
  },
  {
    "nome": "Laranja Pastel",
    "valor": "#FFD9B3"
  },
  {
    "nome": "Verde \u00c1gua",
    "valor": "#CCFFE5"
  },
  {
    "nome": "Lima Pastel",
    "valor": "#E6FFB3"
  },
  {
    "nome": "P\u00eassego",
    "valor": "#FFE0CC"
  },
  {
    "nome": "Lavanda",
    "valor": "#F0E6FF"
  },
  {
    "nome": "Menta",
    "valor": "#B3FFEC"
  },
  {
    "nome": "Amarelo Pastel",
    "valor": "#FFFFCC"
  },
  {
    "nome": "Coral Claro",
    "valor": "#FFCCCC"
  },
  {
    "nome": "Turquesa Claro",
    "valor": "#CCF5FF"
  },
  {
    "nome": "Lil\u00e1s Claro",
    "valor": "#F3CCFF"
  },
  {
    "nome": "Areia",
    "valor": "#FFF5CC"
  },
  {
    "nome": "Verde Musgo Claro",
    "valor": "#D5FFD5"
  },
  {
    "nome": "Bege",
    "valor": "#FFF0D9"
  },
  {
    "nome": "Rosa Beb\u00ea",
    "valor": "#FFE6F0"
  }
];

function gerarDiasUteis(periodos, inicio) {
  const diasGerados = [];
  let data = new Date(inicio);
  let blocosNecessarios = Math.ceil(periodos / 2);
  while (diasGerados.length < blocosNecessarios) {
    if (data.getDay() !== 0 && data.getDay() !== 6) {
      diasGerados.push(data.toLocaleDateString("pt-BR"));
    }
    data.setDate(data.getDate() + 1);
  }
  return diasGerados;
}

function gerarAgenda(periodos, inicio) {
  const agenda = {};
  let total = periodos;
  let data = new Date(inicio);
  console.log("== Iniciando geração de agenda ==");
  console.log("Períodos solicitados:", periodos);
  console.log("Data inicial:", data.toLocaleDateString("pt-BR"));

  let tentativas = 0;
  const limiteBlocos = 60;
  const limiteDias = 90;
  let diasTestados = 0;
  let blocosAlocados = 0;

  while (total > 0 && tentativas < 1000 && diasTestados < limiteDias) {
    tentativas++;
    if (data.getDay() !== 0 && data.getDay() !== 6) {
      diasTestados++;
      const diaStr = data.toLocaleDateString("pt-BR");
      let blocos = [];

      const manhaLivre = !ocupado(diaStr, "09:00-12:00");
      const tardeLivre = !ocupado(diaStr, "13:00-16:00");

      console.log(`[${diaStr}] manhã livre:`, manhaLivre, "| tarde livre:", tardeLivre);

      if (manhaLivre && total > 0) {
        blocos.push("09:00-12:00");
        total--;
        blocosAlocados++;
      }

      if (tardeLivre && total > 0) {
        blocos.push("13:00-16:00");
        total--;
        blocosAlocados++;
      }

      if (blocos.length > 0) {
        agenda[diaStr] = blocos;
        console.log("  Alocado em:", diaStr, "=>", blocos);
      } else {
        console.log("  Nenhum bloco alocado em:", diaStr);
      }
    } else {
      console.log("Pulando fim de semana:", data.toLocaleDateString("pt-BR"));
    }

    data.setDate(data.getDate() + 1);
  }

  if (total > 0) {
    console.warn("!!! Faltaram blocos para alocar:", total);
  } else {
    console.log("✓ Agenda alocada com sucesso:", agenda);
  }

  return agenda;
}

function ocupado(dia, periodo) {
  for (let t of tarefas) {
    if (t.agenda[dia]?.includes(periodo)) return true;
  }
  return false;
}

function gerarTabela() {
  const tbody = document.getElementById("gantt-body");
  const thead = document.getElementById("gantt-head");
  tbody.innerHTML = "";
  thead.innerHTML = "";

  let todosDias = new Set();
  tarefas.forEach(t => {
    Object.keys(t.agenda).forEach(d => todosDias.add(d));
  });
  dias = Array.from(todosDias).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
  console.log("Dias gerados para tabela:", dias);
  const tr1 = document.createElement("tr");
  const tr2 = document.createElement("tr");
  tr1.innerHTML = '<throwspan="2" data-i18n="ganttcharteditor_descri_o">Descrição</th>';
  tr1.className = dias.length > 5 ? "vertical-header" : "";
  dias.forEach(d => {
    const th = document.createElement("th");
    th.colSpan = 2;
    if (dias.length > 10) {
      const span = document.createElement("span");
      span.className = "rotate";
      span.textContent = d;
      th.appendChild(span);
    } else {
      th.textContent = d;
    }
    tr1.appendChild(th);
    tr2.innerHTML += "<th>Manhã</th><th>Tarde</th>";
  });
  thead.appendChild(tr1);
  thead.appendChild(tr2);

  tarefas.forEach((t, i) => {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    const a = document.createElement("a");
    a.href = "#";
    a.textContent = t.descricao;
    a.onclick = () => carregarTarefa(i);
    td.appendChild(a);
    td.style.backgroundColor = t.cor;
    td.style.color = contraste(t.cor);
    tr.appendChild(td);
    dias.forEach(d => {
      ["09:00-12:00", "13:00-16:00"].forEach(p => {
        const cell = document.createElement("td");
        if (t.agenda[d]?.includes(p)) {
          cell.style.backgroundColor = t.cor;
        }
        tr.appendChild(cell);
      });
    });
    tbody.appendChild(tr);
  });
}

function contraste(hex) {
  hex = hex.replace('#', '');
  const r = parseInt(hex.substr(0, 2), 16);
  const g = parseInt(hex.substr(2, 2), 16);
  const b = parseInt(hex.substr(4, 2), 16);
  const luminancia = (0.299 * r + 0.587 * g + 0.114 * b);
  return luminancia > 140 ? "#000" : "#fff";
}

function popularCores() {
  const select = document.getElementById("cor");
  select.innerHTML = "";
  coresDisponiveis.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.valor;
    opt.textContent = c.nome;
    opt.style.backgroundColor = c.valor;
    opt.style.color = contraste(c.valor);
    select.appendChild(opt);
  });
}

function incluirTarefa() {
  const desc = document.getElementById("descricao").value;
  const cor = document.getElementById("cor").value;
  const nomeCor = document.getElementById("cor").selectedOptions[0].textContent;
  const qtd = parseInt(document.getElementById("periodos").value);
  const inicio = document.getElementById("inicio").value;
  if (!desc || !cor || !qtd || !inicio) return alert("Preencha todos os campos.");
  const agenda = gerarAgenda(qtd, inicio);
  const totalBlocos = Object.values(agenda).reduce((acc, v) => acc + v.length, 0);
  if (totalBlocos < qtd) {
    alert("Não há blocos disponíveis suficientes para essa tarefa.");
    return;
  }
  tarefas.push({ descricao: desc, cor, agenda, nomeCor });
  coresDisponiveis = coresDisponiveis.filter(c => c.valor !== cor);
  popularCores();
  gerarTabela();
  console.log('Tarefas:', tarefas);
  limpar();
}

function carregarTarefa(i) {
  const t = tarefas[i];
  document.getElementById("descricao").value = t.descricao;
  document.getElementById("cor").value = t.cor;
  document.getElementById("periodos").value = contarPeriodos(t.agenda);
  tarefaSelecionada = i;
  document.querySelector('button[onclick="incluirTarefa()"]').style.display = "none";
  document.querySelector('button[onclick="editarTarefa()"]').style.display = "inline-block";
  document.getElementById("cancelarEdicao").style.display = "inline-block";
  document.querySelector('button[onclick="excluirTarefa()"]').style.display = "inline-block";
  console.log("Entrou em modo de edição", t);
}

function contarPeriodos(agenda) {
  let total = 0;
  for (let dia in agenda) {
    total += agenda[dia].length;
  }
  return total;
}

function editarTarefa() {
  if (tarefaSelecionada === null) return alert("Selecionar uma tarefa.");
  const desc = document.getElementById("descricao").value;
  const cor = document.getElementById("cor").value;
  const qtd = parseInt(document.getElementById("periodos").value);
  const inicio = document.getElementById("inicio").value;
  const antiga = tarefas[tarefaSelecionada].cor;
  if (!coresDisponiveis.some(c => c.valor === antiga)) {
    const nomeAntiga = tarefas[tarefaSelecionada].nomeCor;
    coresDisponiveis.push({ nome: nomeAntiga, valor: antiga });
  }
  tarefas[tarefaSelecionada] = { descricao: desc, cor, agenda: gerarAgenda(qtd, inicio), nomeCor: document.getElementById("cor").selectedOptions[0].textContent };
  coresDisponiveis = coresDisponiveis.filter(c => c.valor !== cor);
  popularCores();
  gerarTabela();
  console.log('Tarefas:', tarefas);
  limpar();
}

function excluirTarefa() {
  if (tarefaSelecionada === null) return alert("Selecionar uma tarefa.");
  const cor = tarefas[tarefaSelecionada].cor;
  const nomeCor = tarefas[tarefaSelecionada].nomeCor;
  if (!coresDisponiveis.some(c => c.valor === cor)) {
    coresDisponiveis.push({ nome: nomeCor, valor: cor });
  }
  tarefas.splice(tarefaSelecionada, 1);
  popularCores();
  gerarTabela();
  console.log('Tarefas:', tarefas);
  limpar();
}

function exportarJSON() {
  const blob = new Blob([JSON.stringify(tarefas, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "planejamento.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importarJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (Array.isArray(data)) {
        tarefas = data.map(t => {
      if (!t.agenda || Object.keys(t.agenda).length === 0) {
        t.agenda = gerarAgenda(1, document.getElementById("inicio").value);
      }
      return t;
    });
        popularCores();
        gerarTabela();
  console.log('Tarefas:', tarefas);
  limpar();
      } else {
        alert("Arquivo inválido.");
      }
    } catch (err) {
      alert("Erro ao ler arquivo.");
    }
  };
  reader.readAsText(file);
}

function limpar() {
  document.getElementById("descricao").value = "";
  document.getElementById("periodos").value = "1";
  tarefaSelecionada = null;
  document.querySelector('button[onclick="incluirTarefa()"]').style.display = "inline-block";
  document.getElementById("cancelarEdicao").style.display = "none";
  document.querySelector('button[onclick="editarTarefa()"]').style.display = "none";
  document.querySelector('button[onclick="excluirTarefa()"]').style.display = "none";
}


document.getElementById("formulario").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    document.getElementById("periodos").value = "1";
    if (document.getElementById("cor").options.length > 0) {
      incluirTarefa();
    } else {
      alert("Sem cores disponíveis.");
    }
  }
});



document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    limpar();
  }
});


window.onload = () => {
  popularCores();
  gerarTabela();
};
</script>
<script id="i18n-extra" type="application/json">{"en": {"ganttcharteditor_editor_gantt_com_tons_past_is": "Editor Gantt com Tons Pastéis", "ganttcharteditor_descri_o": "Descrição", "ganttcharteditor_62037d4390": "Cor", "ganttcharteditor_per_odos": "Períodos", "ganttcharteditor_1_per_odo_s": "1 período(s)", "ganttcharteditor_2_per_odo_s": "2 período(s)", "ganttcharteditor_3_per_odo_s": "3 período(s)", "ganttcharteditor_4_per_odo_s": "4 período(s)", "ganttcharteditor_5_per_odo_s": "5 período(s)", "ganttcharteditor_6_per_odo_s": "6 período(s)", "ganttcharteditor_7_per_odo_s": "7 período(s)", "ganttcharteditor_8_per_odo_s": "8 período(s)", "ganttcharteditor_9_per_odo_s": "9 período(s)", "ganttcharteditor_in_cio_do_projeto": "Início do Projeto", "ganttcharteditor_incluir": "Incluir", "ganttcharteditor_editar": "Editar", "ganttcharteditor_excluir": "Excluir", "ganttcharteditor_exportar_json": "Exportar JSON"}, "pt": {"ganttcharteditor_editor_gantt_com_tons_past_is": "Editor Gantt com Tons Pastéis", "ganttcharteditor_descri_o": "Descrição", "ganttcharteditor_62037d4390": "Cor", "ganttcharteditor_per_odos": "Períodos", "ganttcharteditor_1_per_odo_s": "1 período(s)", "ganttcharteditor_2_per_odo_s": "2 período(s)", "ganttcharteditor_3_per_odo_s": "3 período(s)", "ganttcharteditor_4_per_odo_s": "4 período(s)", "ganttcharteditor_5_per_odo_s": "5 período(s)", "ganttcharteditor_6_per_odo_s": "6 período(s)", "ganttcharteditor_7_per_odo_s": "7 período(s)", "ganttcharteditor_8_per_odo_s": "8 período(s)", "ganttcharteditor_9_per_odo_s": "9 período(s)", "ganttcharteditor_in_cio_do_projeto": "Início do Projeto", "ganttcharteditor_incluir": "Incluir", "ganttcharteditor_editar": "Editar", "ganttcharteditor_excluir": "Excluir", "ganttcharteditor_exportar_json": "Exportar JSON"}}</script>



<script>window.WT&&WT.init&&WT.init();</script>
</body>
</html>