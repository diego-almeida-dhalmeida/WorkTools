<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gantt Chart Completo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    td, th {
      height: 28px;
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
    }
    .rotate {
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      white-space: nowrap;
    }
    .vertical-header th {
      padding: 2px;
    }
  </style>

<style>
:root{--bg:#0b0e14;--panel:#101524;--chip:#0d1322;--text:#e6f1ff;--muted:#94a3b8;--border:#1b2440;--accent:#5ef2ff;--accent2:#20f59b;--shadow:0 8px 30px rgba(0,0,0,.45);--glow:0 0 12px rgba(32,245,155,.35),0 0 18px rgba(94,242,255,.25)}
html[data-theme="light"]{--bg:#f6f7fb;--panel:#ffffff;--chip:#f2f4f8;--text:#1f2937;--muted:#4b5563;--border:#e5e7eb;--accent:#2563eb;--accent2:#059669;--shadow:0 10px 24px rgba(0,0,0,.08);--glow:none}
.topbar{position:sticky;top:0;z-index:50;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.actions{display:flex;gap:10px;align-items:center}
.lang-toggle button,.theme-toggle{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
.lang-toggle button.active{border-color:var(--accent);box-shadow:var(--glow);color:var(--accent)}
.theme-toggle:hover{border-color:var(--accent2);box-shadow:var(--glow)}
.icon{width:16px;height:16px;display:inline-block}
</style>

</head>
<body class="p-4">
<div class="topbar">
  <div class="subtitle" data-i18n="title_portal">Aplicativos Diversos</div>
  <div class="actions">
    <div class="lang-toggle">
      <button data-lang="en" onclick="setLanguage('en')" class="active" data-i18n="lang_en">English</button>
      <button data-lang="pt" onclick="setLanguage('pt')" data-i18n="lang_pt">Português</button>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()"><span class="icon"></span><span data-i18n="theme_dark">Dark</span></button>
  </div>
</div>

<div class="container">
  <h1class="bg-primary text-white p-3 rounded" data-i18n="ganttcharteditor_editor_gantt_com_tons_past_is">Editor Gantt com Tons Pastéis</h1>

  <div class="card mt-4 shadow-sm">
  <div class="card-header bg-primary text-white">
    Gerenciar Planejamento <span id="cancelarEdicao" style="display:none; cursor:pointer; float:right; font-weight:normal;" onclick="limpar()">❌</span>
  </div>
  <div class="card-body">
    <form id="formulario" class="row g-3">
    <div class="col-md-6">
      <labelclass="form-label" data-i18n="ganttcharteditor_descri_o">Descrição</label>
      <input type="text" id="descricao" class="form-control">
    </div>
    <div class="col-md-3">
      <labelclass="form-label" data-i18n="ganttcharteditor_62037d4390">Cor</label>
      <select id="cor" class="form-select"></select>
    </div>
    <div class="col-md-3">
      <labelclass="form-label" data-i18n="ganttcharteditor_per_odos">Períodos</label>
      <select id="periodos" class="form-select">
        <optionvalue="1" data-i18n="ganttcharteditor_1_per_odo_s">1 período(s)</option><optionvalue="2" data-i18n="ganttcharteditor_2_per_odo_s">2 período(s)</option><optionvalue="3" data-i18n="ganttcharteditor_3_per_odo_s">3 período(s)</option><optionvalue="4" data-i18n="ganttcharteditor_4_per_odo_s">4 período(s)</option><optionvalue="5" data-i18n="ganttcharteditor_5_per_odo_s">5 período(s)</option><optionvalue="6" data-i18n="ganttcharteditor_6_per_odo_s">6 período(s)</option><optionvalue="7" data-i18n="ganttcharteditor_7_per_odo_s">7 período(s)</option><optionvalue="8" data-i18n="ganttcharteditor_8_per_odo_s">8 período(s)</option><optionvalue="9" data-i18n="ganttcharteditor_9_per_odo_s">9 período(s)</option>
      </select>
    </div>
    <div class="col-md-3">
      <labelclass="form-label" data-i18n="ganttcharteditor_in_cio_do_projeto">Início do Projeto</label>
      <input type="date" id="inicio" class="form-control" value="2025-07-30">
    </div>
    <div class="col-12">
      <buttontype="button" class="btn btn-success" onclick="incluirTarefa()" data-i18n="ganttcharteditor_incluir">Incluir</button>
      <buttontype="button" class="btn btn-warning" onclick="editarTarefa()" data-i18n="ganttcharteditor_editar">Editar</button>
      <buttontype="button" class="btn btn-danger" onclick="excluirTarefa()" data-i18n="ganttcharteditor_excluir">Excluir</button>
      <buttontype="button" class="btn btn-secondary" onclick="exportarJSON()" data-i18n="ganttcharteditor_exportar_json">Exportar JSON</button>
      <label class="btn btn-secondary mb-0">
        Importar JSON <input type="file" id="importarJson" style="display:none" onchange="importarJSON(event)">
      </label>
    </div>
  </form>

  </form>
  </div>
</div>
<hr class="my-4">

  <table class="table table-bordered text-center align-middle">
    <thead id="gantt-head"></thead>
    <tbody id="gantt-body"></tbody>
  </table>
</div>

<script>
let tarefas = [];
let dias = [];
let tarefaSelecionada = null;
  document.querySelector('button[onclick="incluirTarefa()"]').style.display = "inline-block";
  document.getElementById("cancelarEdicao").style.display = "none";
  document.querySelector('button[onclick="editarTarefa()"]').style.display = "none";
  document.querySelector('button[onclick="excluirTarefa()"]').style.display = "none";
let coresDisponiveis = [
  {
    "nome": "Vermelho Pastel",
    "valor": "#FFB3B3"
  },
  {
    "nome": "Verde Pastel",
    "valor": "#B3FFB3"
  },
  {
    "nome": "Azul Pastel",
    "valor": "#B3D1FF"
  },
  {
    "nome": "Rosa Pastel",
    "valor": "#FFCCE5"
  },
  {
    "nome": "Ciano Pastel",
    "valor": "#CCFFFF"
  },
  {
    "nome": "Roxo Pastel",
    "valor": "#E0CCFF"
  },
  {
    "nome": "Laranja Pastel",
    "valor": "#FFD9B3"
  },
  {
    "nome": "Verde \u00c1gua",
    "valor": "#CCFFE5"
  },
  {
    "nome": "Lima Pastel",
    "valor": "#E6FFB3"
  },
  {
    "nome": "P\u00eassego",
    "valor": "#FFE0CC"
  },
  {
    "nome": "Lavanda",
    "valor": "#F0E6FF"
  },
  {
    "nome": "Menta",
    "valor": "#B3FFEC"
  },
  {
    "nome": "Amarelo Pastel",
    "valor": "#FFFFCC"
  },
  {
    "nome": "Coral Claro",
    "valor": "#FFCCCC"
  },
  {
    "nome": "Turquesa Claro",
    "valor": "#CCF5FF"
  },
  {
    "nome": "Lil\u00e1s Claro",
    "valor": "#F3CCFF"
  },
  {
    "nome": "Areia",
    "valor": "#FFF5CC"
  },
  {
    "nome": "Verde Musgo Claro",
    "valor": "#D5FFD5"
  },
  {
    "nome": "Bege",
    "valor": "#FFF0D9"
  },
  {
    "nome": "Rosa Beb\u00ea",
    "valor": "#FFE6F0"
  }
];

function gerarDiasUteis(periodos, inicio) {
  const diasGerados = [];
  let data = new Date(inicio);
  let blocosNecessarios = Math.ceil(periodos / 2);
  while (diasGerados.length < blocosNecessarios) {
    if (data.getDay() !== 0 && data.getDay() !== 6) {
      diasGerados.push(data.toLocaleDateString("pt-BR"));
    }
    data.setDate(data.getDate() + 1);
  }
  return diasGerados;
}

function gerarAgenda(periodos, inicio) {
  const agenda = {};
  let total = periodos;
  let data = new Date(inicio);
  console.log("== Iniciando geração de agenda ==");
  console.log("Períodos solicitados:", periodos);
  console.log("Data inicial:", data.toLocaleDateString("pt-BR"));

  let tentativas = 0;
  const limiteBlocos = 60;
  const limiteDias = 90;
  let diasTestados = 0;
  let blocosAlocados = 0;

  while (total > 0 && tentativas < 1000 && diasTestados < limiteDias) {
    tentativas++;
    if (data.getDay() !== 0 && data.getDay() !== 6) {
      diasTestados++;
      const diaStr = data.toLocaleDateString("pt-BR");
      let blocos = [];

      const manhaLivre = !ocupado(diaStr, "09:00-12:00");
      const tardeLivre = !ocupado(diaStr, "13:00-16:00");

      console.log(`[${diaStr}] manhã livre:`, manhaLivre, "| tarde livre:", tardeLivre);

      if (manhaLivre && total > 0) {
        blocos.push("09:00-12:00");
        total--;
        blocosAlocados++;
      }

      if (tardeLivre && total > 0) {
        blocos.push("13:00-16:00");
        total--;
        blocosAlocados++;
      }

      if (blocos.length > 0) {
        agenda[diaStr] = blocos;
        console.log("  Alocado em:", diaStr, "=>", blocos);
      } else {
        console.log("  Nenhum bloco alocado em:", diaStr);
      }
    } else {
      console.log("Pulando fim de semana:", data.toLocaleDateString("pt-BR"));
    }

    data.setDate(data.getDate() + 1);
  }

  if (total > 0) {
    console.warn("!!! Faltaram blocos para alocar:", total);
  } else {
    console.log("✓ Agenda alocada com sucesso:", agenda);
  }

  return agenda;
}

function ocupado(dia, periodo) {
  for (let t of tarefas) {
    if (t.agenda[dia]?.includes(periodo)) return true;
  }
  return false;
}

function gerarTabela() {
  const tbody = document.getElementById("gantt-body");
  const thead = document.getElementById("gantt-head");
  tbody.innerHTML = "";
  thead.innerHTML = "";

  let todosDias = new Set();
  tarefas.forEach(t => {
    Object.keys(t.agenda).forEach(d => todosDias.add(d));
  });
  dias = Array.from(todosDias).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
  console.log("Dias gerados para tabela:", dias);
  const tr1 = document.createElement("tr");
  const tr2 = document.createElement("tr");
  tr1.innerHTML = '<throwspan="2" data-i18n="ganttcharteditor_descri_o">Descrição</th>';
  tr1.className = dias.length > 5 ? "vertical-header" : "";
  dias.forEach(d => {
    const th = document.createElement("th");
    th.colSpan = 2;
    if (dias.length > 10) {
      const span = document.createElement("span");
      span.className = "rotate";
      span.textContent = d;
      th.appendChild(span);
    } else {
      th.textContent = d;
    }
    tr1.appendChild(th);
    tr2.innerHTML += "<th>Manhã</th><th>Tarde</th>";
  });
  thead.appendChild(tr1);
  thead.appendChild(tr2);

  tarefas.forEach((t, i) => {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    const a = document.createElement("a");
    a.href = "#";
    a.textContent = t.descricao;
    a.onclick = () => carregarTarefa(i);
    td.appendChild(a);
    td.style.backgroundColor = t.cor;
    td.style.color = contraste(t.cor);
    tr.appendChild(td);
    dias.forEach(d => {
      ["09:00-12:00", "13:00-16:00"].forEach(p => {
        const cell = document.createElement("td");
        if (t.agenda[d]?.includes(p)) {
          cell.style.backgroundColor = t.cor;
        }
        tr.appendChild(cell);
      });
    });
    tbody.appendChild(tr);
  });
}

function contraste(hex) {
  hex = hex.replace('#', '');
  const r = parseInt(hex.substr(0, 2), 16);
  const g = parseInt(hex.substr(2, 2), 16);
  const b = parseInt(hex.substr(4, 2), 16);
  const luminancia = (0.299 * r + 0.587 * g + 0.114 * b);
  return luminancia > 140 ? "#000" : "#fff";
}

function popularCores() {
  const select = document.getElementById("cor");
  select.innerHTML = "";
  coresDisponiveis.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.valor;
    opt.textContent = c.nome;
    opt.style.backgroundColor = c.valor;
    opt.style.color = contraste(c.valor);
    select.appendChild(opt);
  });
}

function incluirTarefa() {
  const desc = document.getElementById("descricao").value;
  const cor = document.getElementById("cor").value;
  const nomeCor = document.getElementById("cor").selectedOptions[0].textContent;
  const qtd = parseInt(document.getElementById("periodos").value);
  const inicio = document.getElementById("inicio").value;
  if (!desc || !cor || !qtd || !inicio) return alert("Preencha todos os campos.");
  const agenda = gerarAgenda(qtd, inicio);
  const totalBlocos = Object.values(agenda).reduce((acc, v) => acc + v.length, 0);
  if (totalBlocos < qtd) {
    alert("Não há blocos disponíveis suficientes para essa tarefa.");
    return;
  }
  tarefas.push({ descricao: desc, cor, agenda, nomeCor });
  coresDisponiveis = coresDisponiveis.filter(c => c.valor !== cor);
  popularCores();
  gerarTabela();
  console.log('Tarefas:', tarefas);
  limpar();
}

function carregarTarefa(i) {
  const t = tarefas[i];
  document.getElementById("descricao").value = t.descricao;
  document.getElementById("cor").value = t.cor;
  document.getElementById("periodos").value = contarPeriodos(t.agenda);
  tarefaSelecionada = i;
  document.querySelector('button[onclick="incluirTarefa()"]').style.display = "none";
  document.querySelector('button[onclick="editarTarefa()"]').style.display = "inline-block";
  document.getElementById("cancelarEdicao").style.display = "inline-block";
  document.querySelector('button[onclick="excluirTarefa()"]').style.display = "inline-block";
  console.log("Entrou em modo de edição", t);
}

function contarPeriodos(agenda) {
  let total = 0;
  for (let dia in agenda) {
    total += agenda[dia].length;
  }
  return total;
}

function editarTarefa() {
  if (tarefaSelecionada === null) return alert("Selecionar uma tarefa.");
  const desc = document.getElementById("descricao").value;
  const cor = document.getElementById("cor").value;
  const qtd = parseInt(document.getElementById("periodos").value);
  const inicio = document.getElementById("inicio").value;
  const antiga = tarefas[tarefaSelecionada].cor;
  if (!coresDisponiveis.some(c => c.valor === antiga)) {
    const nomeAntiga = tarefas[tarefaSelecionada].nomeCor;
    coresDisponiveis.push({ nome: nomeAntiga, valor: antiga });
  }
  tarefas[tarefaSelecionada] = { descricao: desc, cor, agenda: gerarAgenda(qtd, inicio), nomeCor: document.getElementById("cor").selectedOptions[0].textContent };
  coresDisponiveis = coresDisponiveis.filter(c => c.valor !== cor);
  popularCores();
  gerarTabela();
  console.log('Tarefas:', tarefas);
  limpar();
}

function excluirTarefa() {
  if (tarefaSelecionada === null) return alert("Selecionar uma tarefa.");
  const cor = tarefas[tarefaSelecionada].cor;
  const nomeCor = tarefas[tarefaSelecionada].nomeCor;
  if (!coresDisponiveis.some(c => c.valor === cor)) {
    coresDisponiveis.push({ nome: nomeCor, valor: cor });
  }
  tarefas.splice(tarefaSelecionada, 1);
  popularCores();
  gerarTabela();
  console.log('Tarefas:', tarefas);
  limpar();
}

function exportarJSON() {
  const blob = new Blob([JSON.stringify(tarefas, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "planejamento.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importarJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (Array.isArray(data)) {
        tarefas = data.map(t => {
      if (!t.agenda || Object.keys(t.agenda).length === 0) {
        t.agenda = gerarAgenda(1, document.getElementById("inicio").value);
      }
      return t;
    });
        popularCores();
        gerarTabela();
  console.log('Tarefas:', tarefas);
  limpar();
      } else {
        alert("Arquivo inválido.");
      }
    } catch (err) {
      alert("Erro ao ler arquivo.");
    }
  };
  reader.readAsText(file);
}

function limpar() {
  document.getElementById("descricao").value = "";
  document.getElementById("periodos").value = "1";
  tarefaSelecionada = null;
  document.querySelector('button[onclick="incluirTarefa()"]').style.display = "inline-block";
  document.getElementById("cancelarEdicao").style.display = "none";
  document.querySelector('button[onclick="editarTarefa()"]').style.display = "none";
  document.querySelector('button[onclick="excluirTarefa()"]').style.display = "none";
}


document.getElementById("formulario").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    document.getElementById("periodos").value = "1";
    if (document.getElementById("cor").options.length > 0) {
      incluirTarefa();
    } else {
      alert("Sem cores disponíveis.");
    }
  }
});



document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    limpar();
  }
});


window.onload = () => {
  popularCores();
  gerarTabela();
};
</script>
<script id="i18n-extra" type="application/json">{"en": {"ganttcharteditor_editor_gantt_com_tons_past_is": "Editor Gantt com Tons Pastéis", "ganttcharteditor_descri_o": "Descrição", "ganttcharteditor_62037d4390": "Cor", "ganttcharteditor_per_odos": "Períodos", "ganttcharteditor_1_per_odo_s": "1 período(s)", "ganttcharteditor_2_per_odo_s": "2 período(s)", "ganttcharteditor_3_per_odo_s": "3 período(s)", "ganttcharteditor_4_per_odo_s": "4 período(s)", "ganttcharteditor_5_per_odo_s": "5 período(s)", "ganttcharteditor_6_per_odo_s": "6 período(s)", "ganttcharteditor_7_per_odo_s": "7 período(s)", "ganttcharteditor_8_per_odo_s": "8 período(s)", "ganttcharteditor_9_per_odo_s": "9 período(s)", "ganttcharteditor_in_cio_do_projeto": "Início do Projeto", "ganttcharteditor_incluir": "Incluir", "ganttcharteditor_editar": "Editar", "ganttcharteditor_excluir": "Excluir", "ganttcharteditor_exportar_json": "Exportar JSON"}, "pt": {"ganttcharteditor_editor_gantt_com_tons_past_is": "Editor Gantt com Tons Pastéis", "ganttcharteditor_descri_o": "Descrição", "ganttcharteditor_62037d4390": "Cor", "ganttcharteditor_per_odos": "Períodos", "ganttcharteditor_1_per_odo_s": "1 período(s)", "ganttcharteditor_2_per_odo_s": "2 período(s)", "ganttcharteditor_3_per_odo_s": "3 período(s)", "ganttcharteditor_4_per_odo_s": "4 período(s)", "ganttcharteditor_5_per_odo_s": "5 período(s)", "ganttcharteditor_6_per_odo_s": "6 período(s)", "ganttcharteditor_7_per_odo_s": "7 período(s)", "ganttcharteditor_8_per_odo_s": "8 período(s)", "ganttcharteditor_9_per_odo_s": "9 período(s)", "ganttcharteditor_in_cio_do_projeto": "Início do Projeto", "ganttcharteditor_incluir": "Incluir", "ganttcharteditor_editar": "Editar", "ganttcharteditor_excluir": "Excluir", "ganttcharteditor_exportar_json": "Exportar JSON"}}</script>

<script>
(function(){
  const base = window.__i18nBase || {
    en: {
      title_portal: "Aplicativos Diversos",
      subtitle_portal: "Central portal with links to all apps in this repository.",
      open_app: "Open app",
      app_apex_title: "Apex Test Coverage Viewer",
      app_apex_desc: "Web tool to visualize Apex test coverage interactively and clearly.",
      app_gantt_title: "Gantt Chart Editor",
      app_gantt_desc: "Gantt chart editor (HTML + JavaScript) to plan and visualize tasks.",
      app_revise_title: "Revise.it",
      app_revise_desc: "Skeleton app to apply spaced repetition in daily life.",
      lang_en: "English",
      lang_pt: "Português",
      theme_dark: "Dark",
      theme_light: "Light"
    },
    pt: {
      title_portal: "Aplicativos Diversos",
      subtitle_portal: "Portal central com links para todos os apps deste repositório.",
      open_app: "Abrir app",
      app_apex_title: "Apex Test Coverage Viewer",
      app_apex_desc: "Ferramenta web para visualizar cobertura de testes Apex de forma interativa e clara.",
      app_gantt_title: "Gantt Chart Editor",
      app_gantt_desc: "Editor de gráficos de Gantt (HTML + JavaScript) para planejar e visualizar tarefas.",
      app_revise_title: "Revise.it",
      app_revise_desc: "Skeleton de aplicação para aplicar técnica de revisão espaçada no dia a dia.",
      lang_en: "English",
      lang_pt: "Português",
      theme_dark: "Escuro",
      theme_light: "Claro"
    }
  };

  function deepMerge(target, source){
    for (const k in source){
      if (source[k] && typeof source[k] === 'object' && !Array.isArray(source[k])){
        target[k] = target[k] || {};
        deepMerge(target[k], source[k]);
      } else {
        target[k] = source[k];
      }
    }
    return target;
  }

  const extraEl = document.getElementById('i18n-extra');
  if (extraEl){
    try {
      const extra = JSON.parse(extraEl.textContent || "{}");
      deepMerge(base, extra);
    } catch(e){}
  }

  let lang = localStorage.getItem('lang') || 'en';
  let theme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', theme);

  function applyI18n(root=document){
    root.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      const t = (base[lang] && base[lang][key]) || "";
      if (t) el.textContent = t;
    });
    document.querySelectorAll(".lang-toggle button").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.lang === lang);
    });
    const icon = document.querySelector(".theme-toggle .icon");
    if (icon){
      icon.innerHTML = theme === 'dark'
        ? '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/></svg>'
        : '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.8 1.8-1.8zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9-10v-2h-3v2h3zM6.76 19.16l-1.8 1.8 1.79 1.79 1.8-1.8-1.79-1.79zM11 1h2v3h-2V1zm7.07 3.05l-1.79 1.8 1.8 1.79 1.79-1.79-1.8-1.8zM4.22 10.99A7.78 7.78 0 1 0 12 4.22 7.78 7.78 0 0 0 4.22 11z"/></svg>';
    }
  }

  window.setLanguage = function(newLang){
    lang = newLang;
    localStorage.setItem('lang', lang);
    applyI18n();
  };
  window.toggleTheme = function(){
    theme = theme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', theme);
    document.documentElement.setAttribute('data-theme', theme);
    applyI18n();
  };

  document.addEventListener("DOMContentLoaded", applyI18n);
})();
</script>

</body>
</html>
