<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apex Test Coverage Viewer</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151821; --muted:#9aa4b2; --text:#e8ecf1; --accent:#4aa3ff; --danger:#ff5b5b;
      --ok:#2fd47a; --border:#242939;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-size:18px;margin:12px 0}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr 2fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 20px rgba(0,0,0,.25)}
    .card header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
    .card header h2{margin:0;font-size:15px}
    .card .body{padding:12px 14px}
    textarea{width:100%;min-height:180px;resize:vertical;background:#0b0d12;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    pre{background:#0b0f18;border:1px solid var(--border);border-radius:8px;padding:10px;overflow:auto}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
    input[type="text"], input[type="url"], input[type="number"], input[type="password"]{flex:1 1 220px;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#0b0d12;color:var(--text)}
    button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#101626;color:var(--text);cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1a66ff,#1247b8);border-color:#0f2f7a}
    button.ghost{background:#101318}
    button:disabled{opacity:.6;cursor:not-allowed}
    select{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#0b0d12;color:var(--text)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:6px 10px}
    tbody tr{background:#0b0f18;border:1px solid var(--border);transition:transform .06s ease}
    tbody tr:hover{transform:translateY(-1px)}
    td{padding:10px}
    .num{font-variant-numeric:tabular-nums;text-align:right}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#0f1320}
    .pct-ok .badge{background:rgba(47,212,122,.12);border-color:rgba(47,212,122,.35);color:var(--ok)}
    .pct-bad{outline:1px solid rgba(255,91,91,.35);background:linear-gradient(180deg,rgba(255,91,91,.08),transparent)}
    .pct-bad .badge{background:rgba(255,91,91,.12);border-color:rgba(255,91,91,.35);color:var(--danger)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .sticky{position:sticky;top:0;background:var(--panel);z-index:2;border-bottom:1px solid var(--border)}
    .small{font-size:12px}
    .checkbox{width:18px;height:18px}
    .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b0f18}
    .totals{display:flex;gap:10px;flex-wrap:wrap}
    .totals .pill strong{color:var(--accent)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .footer-note{margin-top:8px;color:var(--muted);font-size:12px}
    code.k{background:#0b0f18;border:1px solid var(--border);padding:1px 6px;border-radius:6px}
    .warn{color:#ffd479}
    .api-box{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#0b0f18}
    details.examples summary{cursor:pointer;user-select:none}
    .example-bar{display:flex;gap:8px;align-items:center;margin:8px 0}
  </style>

<style>
:root{--bg:#0b0e14;--panel:#101524;--chip:#0d1322;--text:#e6f1ff;--muted:#94a3b8;--border:#1b2440;--accent:#5ef2ff;--accent2:#20f59b;--shadow:0 8px 30px rgba(0,0,0,.45);--glow:0 0 12px rgba(32,245,155,.35),0 0 18px rgba(94,242,255,.25)}
html[data-theme="light"]{--bg:#f6f7fb;--panel:#ffffff;--chip:#f2f4f8;--text:#1f2937;--muted:#4b5563;--border:#e5e7eb;--accent:#2563eb;--accent2:#059669;--shadow:0 10px 24px rgba(0,0,0,.08);--glow:none}
.topbar{position:sticky;top:0;z-index:50;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.actions{display:flex;gap:10px;align-items:center}
.lang-toggle button,.theme-toggle{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
.lang-toggle button.active{border-color:var(--accent);box-shadow:var(--glow);color:var(--accent)}
.theme-toggle:hover{border-color:var(--accent2);box-shadow:var(--glow)}
.icon{width:16px;height:16px;display:inline-block}
</style>

</head>
<body>
<div class="topbar">
  <div class="subtitle" data-i18n="title_portal">Aplicativos Diversos</div>
  <div class="actions">
    <div class="lang-toggle">
      <button data-lang="en" onclick="setLanguage('en')" class="active" data-i18n="lang_en">English</button>
      <button data-lang="pt" onclick="setLanguage('pt')" data-i18n="lang_pt">Português</button>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()"><span class="icon"></span><span data-i18n="theme_dark">Dark</span></button>
  </div>
</div>

  <div class="wrap">
    <h1>Apex Test Coverage Viewer</h1>

    <div class="grid">
      <!-- Input panel -->
      <section class="card">
        <header><h2>Data input</h2></header>
        <div class="body">
          <div class="row">
            <labelfor="source" data-i18n="apextestcoverageviewer_source">Source:</label>
            <select id="source">
              <optionvalue="paste" selected data-i18n="apextestcoverageviewer_paste_json_csv_tsv">Paste (JSON / CSV / TSV)</option>
              <optionvalue="api" data-i18n="apextestcoverageviewer_ea0b5aac68">Salesforce Tooling API (manual auth required)</option>
            </select>
          </div>

          <!-- Paste mode -->
          <div id="pasteBox">
            <div class="row">
              <buttonid="btnLoad" class="primary" data-i18n="apextestcoverageviewer_load_data">Load Data</button>
              <buttonid="btnSample" class="ghost" data-i18n="apextestcoverageviewer_sample">Sample</button>
              <span class="muted small">Expected fields: <code class="k">ApexClassOrTrigger.Name</code>, <code class="k">NumLinesCovered</code>, <code class="k">NumLinesUncovered</code></span>
            </div>
            <textarea id="inputRaw" placeholder='Paste JSON, CSV, or TSV here.'></textarea>

            <!-- Examples block with Tooling API SOQL -->
            <details class="examples" style="margin-top:10px">
              <summary>Input examples and Tooling API SOQL</summary>

              <div class="example-bar">
                <strong>JSON</strong>
                <buttonclass="ghost" data-copy="#ex-json" data-i18n="apextestcoverageviewer_copy">Copy</button>
                <buttonclass="ghost" data-fill="#ex-json" data-i18n="apextestcoverageviewer_fill_textarea">Fill textarea</button>
              </div>
              <pre id="ex-json"><code>[
  {"ApexClassOrTrigger.Name":"AccountTrigger","NumLinesCovered":5,"NumLinesUncovered":1},
  {"ApexClassOrTrigger.Name":"AccountUtils","NumLinesCovered":92,"NumLinesUncovered":446}
]</code></pre>

              <div class="example-bar">
                <strong>CSV</strong>
                <buttonclass="ghost" data-copy="#ex-csv" data-i18n="apextestcoverageviewer_copy">Copy</button>
                <buttonclass="ghost" data-fill="#ex-csv" data-i18n="apextestcoverageviewer_fill_textarea">Fill textarea</button>
              </div>
              <pre id="ex-csv"><code>ApexClassOrTrigger.Name,NumLinesCovered,NumLinesUncovered
AccountTrigger,5,1
AccountUtils,92,446</code></pre>

              <div class="example-bar">
                <strong>TSV</strong>
                <buttonclass="ghost" data-copy="#ex-tsv" data-i18n="apextestcoverageviewer_copy">Copy</button>
                <buttonclass="ghost" data-fill="#ex-tsv" data-i18n="apextestcoverageviewer_fill_textarea">Fill textarea</button>
              </div>
              <pre id="ex-tsv"><code>ApexClassOrTrigger.Name	NumLinesCovered	NumLinesUncovered
AccountTrigger	5	1
AccountUtils	92	446</code></pre>

              <div class="example-bar">
                <strong>Tooling API SOQL</strong>
                <buttonclass="ghost" data-copy="#ex-soql" data-i18n="apextestcoverageviewer_copy">Copy</button>
              </div>
              <pre id="ex-soql"><code>SELECT ApexClassOrTrigger.Name, NumLinesCovered, NumLinesUncovered
FROM ApexCodeCoverageAggregate</code></pre>

              <div class="hint">
                <spanclass="warn" data-i18n="apextestcoverageviewer_important">Important:</span> run the SOQL in **Tooling API** context and paste the exported result (JSON/CSV/TSV) above,
                or switch to the Tooling API mode and provide a valid token. Example CLI:
                <code class="k">sfdx force:data:soql:query -t -q "SELECT ApexClassOrTrigger.Name, NumLinesCovered, NumLinesUncovered FROM ApexCodeCoverageAggregate" --json</code>
              </div>
            </details>
          </div>

          <!-- API mode -->
          <div id="apiBox" class="api-box" style="display:none">
            <div class="row">
              <input id="instanceUrl" type="url" placeholder="Instance URL (e.g., https://yourDomain.my.salesforce.com)" />
            </div>
            <div class="row">
              <input id="apiVersion" type="number" min="30" max="99" step="1" value="61" style="max-width:140px" />
              <input id="accessToken" type="password" placeholder="Access Token (Bearer)" />
            </div>
            <div class="row">
              <input id="soql" type="text" value="SELECT ApexClassOrTrigger.Name, NumLinesCovered, NumLinesUncovered FROM ApexCodeCoverageAggregate" />
              <buttonid="btnRun" class="primary" data-i18n="apextestcoverageviewer_run_tooling_query">Run Tooling Query</button>
            </div>
            <div class="hint">
              <spanclass="warn" data-i18n="apextestcoverageviewer_important">Important:</span> you must provide a valid token and have CORS allowed for your origin.
              This runs a GET to <code class="k">/services/data/vXX.X/tooling/query/?q=...</code> with <code class="k">Authorization: Bearer &lt;token&gt;</code>.
            </div>
          </div>

          <div id="err" class="hint"></div>
        </div>
      </section>

      <!-- Main table -->
      <section class="card">
        <header class="sticky">
          <h2style="flex:1" data-i18n="apextestcoverageviewer_all_results">All results</h2>
          <div class="toolbar">
            <input type="text" id="search" placeholder="Search by name..." />
            <buttonid="selectVisible" class="ghost" data-i18n="apextestcoverageviewer_select_visible">Select visible</button>
            <buttonid="clearSelection" class="ghost" data-i18n="apextestcoverageviewer_clear_selection">Clear selection</button>
          </div>
        </header>
        <div class="body">
          <div class="totals" id="totals"></div>
          <table id="mainTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="checkAll" class="checkbox" title="Select all"/></th>
                <th>Class/Trigger</th>
                <thclass="num" data-i18n="apextestcoverageviewer_covered">Covered</th>
                <thclass="num" data-i18n="apextestcoverageviewer_uncovered">Uncovered</th>
                <thclass="num" data-i18n="apextestcoverageviewer_covered">% Covered</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="footer-note">Rows with coverage below 80% are highlighted in red.</div>
        </div>
      </section>
    </div>

    <!-- Refined table -->
    <section class="card" style="margin-top:16px">
      <header>
        <h2style="flex:1" data-i18n="apextestcoverageviewer_refined_table_selected">Refined table (selected)</h2>
        <div class="toolbar">
          <buttonid="exportCsv" class="ghost" data-i18n="apextestcoverageviewer_export_csv">Export CSV</button>
          <span id="refinedTotals" class="muted small"></span>
        </div>
      </header>
      <div class="body">
        <table id="refinedTable">
          <thead>
            <tr>
              <th>Class/Trigger</th>
              <thclass="num" data-i18n="apextestcoverageviewer_covered">Covered</th>
              <thclass="num" data-i18n="apextestcoverageviewer_uncovered">Uncovered</th>
              <thclass="num" data-i18n="apextestcoverageviewer_covered">% Covered</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>

  <script>
    // State
    let rows = [];
    let filteredIdx = [];
    let selected = new Set();

    const $ = sel => document.querySelector(sel);
    const mainBody = $('#mainTable tbody');
    const refinedBody = $('#refinedTable tbody');

    // Mode switching
    $('#source').addEventListener('change', (e)=>{
      const mode = e.target.value;
      $('#pasteBox').style.display = mode==='paste' ? '' : 'none';
      $('#apiBox').style.display = mode==='api' ? '' : 'none';
      $('#err').textContent = '';
    });

    // Examples: copy/fill
    document.addEventListener('click', (e)=>{
      const copySel = e.target.getAttribute('data-copy');
      const fillSel = e.target.getAttribute('data-fill');
      if(copySel){
        const text = document.querySelector(copySel)?.innerText ?? '';
        navigator.clipboard.writeText(text).catch(()=>{});
      }
      if(fillSel){
        const text = document.querySelector(fillSel)?.innerText ?? '';
        $('#inputRaw').value = text;
      }
    });

    // Helpers
    function toInt(v){ const n = Number(v); return Number.isFinite(n) ? Math.max(0, Math.trunc(n)) : 0; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function sum(list){
      const covered = list.reduce((a,b)=>a+b.covered,0);
      const uncovered = list.reduce((a,b)=>a+b.uncovered,0);
      const total = covered + uncovered;
      const pct = total>0 ? (covered/total)*100 : 0;
      return {covered, uncovered, total, pct};
    }

    function normalizeObjects(input){
      return input.map(item=>{
        const name = item["ApexClassOrTrigger.Name"] ?? item.ApexClassOrTrigger?.Name ?? item.Name ?? "";
        const covered = toInt(item.NumLinesCovered);
        const uncovered = toInt(item.NumLinesUncovered);
        const total = covered + uncovered;
        const pct = total > 0 ? (covered/total)*100 : 0;
        return { name, covered, uncovered, total, pct };
      }).filter(x => x.name !== "");
    }

    // Detect & parse
    function detectFormat(text){
      const t = text.trim();
      if(!t) return 'empty';
      if(t.startsWith('[') || t.startsWith('{')) return 'json';
      if(t.includes('\t')) return 'tsv';
      if(t.includes(',')) return 'csv';
      return 'unknown';
    }

    function parseAny(text){
      const fmt = detectFormat(text);
      if(fmt==='json'){
        const data = JSON.parse(text);
        if(Array.isArray(data)) return normalizeObjects(data);
        if(data && Array.isArray(data.records)) return normalizeObjects(data.records);
        throw new Error('JSON must be an array or have a "records" array.');
      } else if(fmt==='csv'){
        const arr = parseCSV(text, ',');
        return normalizeObjects(arrayToObjects(arr));
      } else if(fmt==='tsv'){
        const arr = parseCSV(text, '\t');
        return normalizeObjects(arrayToObjects(arr));
      } else if(fmt==='empty'){
        throw new Error('Empty input.');
      } else {
        throw new Error('Could not detect format. Provide JSON, CSV or TSV.');
      }
    }

    function arrayToObjects(matrix){
      if(!matrix.length) return [];
      const headers = matrix[0].map(h => h.trim());
      const out = [];
      for(let i=1;i<matrix.length;i++){
        const row = {};
        for(let j=0;j<headers.length;j++){
          row[headers[j]] = matrix[i][j] ?? '';
        }
        out.push(row);
      }
      return out;
    }

    // Minimal CSV/TSV parser
    function parseCSV(text, sep=','){
      const rows = [];
      let cur = [], val = '', inQuotes = false;
      const pushCell = () => { cur.push(val); val=''; };
      const pushRow  = () => { rows.push(cur); cur=[]; };
      for(let i=0;i<text.length;i++){
        const ch = text[i], nxt = text[i+1];
        if(inQuotes){
          if(ch === '"'){
            if(nxt === '"'){ val += '"'; i++; } else { inQuotes = false; }
          } else { val += ch; }
        } else {
          if(ch === '"'){ inQuotes = true; }
          else if(ch === sep){ pushCell(); }
          else if(ch === '\n'){ pushCell(); pushRow(); }
          else if(ch === '\r'){ /* ignore CR */ }
          else { val += ch; }
        }
      }
      pushCell(); if(cur.length>1 || rows.length===0) pushRow();
      return rows.filter(r => r.some(c => String(c).trim()!==''));
    }

    // Render
    function renderTable(){
      mainBody.innerHTML = '';
      const term = $('#search').value.trim().toLowerCase();
      filteredIdx = [];
      rows.forEach((r, i)=>{
        if(term && !r.name.toLowerCase().includes(term)) return;
        filteredIdx.push(i);

        const tr = document.createElement('tr');
        tr.className = r.pct < 80 ? 'pct-bad' : 'pct-ok';

        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.className = 'checkbox'; cb.checked = selected.has(i);
        cb.addEventListener('change', ()=>{
          if(cb.checked) selected.add(i); else selected.delete(i);
          renderRefined();
        });

        tr.innerHTML = `
          <td></td>
          <td>${escapeHtml(r.name)}</td>
          <tdclass="num" data-i18n="apextestcoverageviewer_r_covered">${r.covered}</td>
          <tdclass="num" data-i18n="apextestcoverageviewer_r_uncovered">${r.uncovered}</td>
          <td class="num"><spanclass="badge" data-i18n="apextestcoverageviewer_r_pct_tofixed_2">${r.pct.toFixed(2)}%</span></td>
        `;
        tr.firstElementChild.appendChild(cb);
        mainBody.appendChild(tr);
      });

      const totals = sum(rows);
      $('#totals').innerHTML = `
        <span class="pill">Total lines: <strong>${totals.total}</strong></span>
        <span class="pill">Covered: <strong>${totals.covered}</strong></span>
        <span class="pill">Uncovered: <strong>${totals.uncovered}</strong></span>
        <span class="pill">Overall %: <strong>${totals.pct.toFixed(2)}%</strong></span>
        <span class="pill">Items: <strong>${rows.length}</strong></span>
      `;
      $('#checkAll').checked = filteredIdx.every(i => selected.has(i)) && filteredIdx.length>0;
      renderRefined();
    }

    function renderRefined(){
      refinedBody.innerHTML = '';
      const chosen = [...selected].map(i => rows[i]);
      chosen.forEach(r=>{
        const tr = document.createElement('tr');
        tr.className = r.pct < 80 ? 'pct-bad' : 'pct-ok';
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <tdclass="num" data-i18n="apextestcoverageviewer_r_covered">${r.covered}</td>
          <tdclass="num" data-i18n="apextestcoverageviewer_r_uncovered">${r.uncovered}</td>
          <td class="num"><spanclass="badge" data-i18n="apextestcoverageviewer_r_pct_tofixed_2">${r.pct.toFixed(2)}%</span></td>
        `;
        refinedBody.appendChild(tr);
      });
      const totals = sum(chosen);
      $('#refinedTotals').textContent =
        chosen.length ? `Selected: ${chosen.length} • Avg %: ${totals.pct.toFixed(2)}%` : 'No selection';
    }

    // Paste mode actions
    $('#btnLoad').addEventListener('click', ()=>{
      $('#err').textContent = '';
      selected.clear();
      try{
        rows = parseAny($('#inputRaw').value);
        if(!rows.length) throw new Error('No valid rows found.');
        renderTable();
      }catch(e){
        rows = []; mainBody.innerHTML = ''; refinedBody.innerHTML = '';
        $('#totals').innerHTML = ''; $('#refinedTotals').textContent = '';
        $('#err').textContent = 'Error: ' + e.message;
      }
    });

    $('#btnSample').addEventListener('click', ()=>{
      const sample = [
        {"ApexClassOrTrigger.Name":"AccountTrigger","NumLinesCovered":5,"NumLinesUncovered":1},
        {"ApexClassOrTrigger.Name":"ATL_AvayaConnectorController","NumLinesCovered":137,"NumLinesUncovered":16},
        {"ApexClassOrTrigger.Name":"ATL_AutosservicoGetInvalidAsset","NumLinesCovered":31,"NumLinesUncovered":11},
        {"ApexClassOrTrigger.Name":"ATL_Utils","NumLinesCovered":92,"NumLinesUncovered":446},
        {"ApexClassOrTrigger.Name":"BusinessHoursUtil","NumLinesCovered":39,"NumLinesUncovered":1},
        {"ApexClassOrTrigger.Name":"TriggerHandler","NumLinesCovered":44,"NumLinesUncovered":59}
      ];
      $('#inputRaw').value = JSON.stringify(sample, null, 2);
    });

    // API mode actions
    async function runTooling(){
      const base = $('#instanceUrl').value.trim().replace(/\/+$/,'');
      const v = $('#apiVersion').value.trim();
      const token = $('#accessToken').value.trim();
      const soql = $('#soql').value.trim();
      if(!base || !v || !token || !soql){
        throw new Error('Instance URL, API Version, Access Token and SOQL are required.');
      }
      const url = `${base}/services/data/v${encodeURIComponent(v)}/tooling/query/?q=${encodeURIComponent(soql)}`;
      const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
      if(!res.ok){
        const t = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status} ${res.statusText} • ${t.slice(0,300)}`);
      }
      const json = await res.json();
      const records = Array.isArray(json.records) ? json.records : [];
      return normalizeObjects(records);
    }

    $('#btnRun').addEventListener('click', async ()=>{
      $('#err').textContent = '';
      selected.clear();
      try{
        rows = await runTooling();
        if(!rows.length) throw new Error('No records returned or fields missing.');
        renderTable();
      }catch(e){
        rows = []; mainBody.innerHTML = ''; refinedBody.innerHTML = '';
        $('#totals').innerHTML = ''; $('#refinedTotals').textContent = '';
        $('#err').textContent = 'Tooling API error: ' + e.message;
      }
    });

    // Common controls
    $('#search').addEventListener('input', renderTable);

    $('#checkAll').addEventListener('change', (e)=>{
      const mark = e.target.checked;
      filteredIdx.forEach(i => mark ? selected.add(i) : selected.delete(i));
      renderTable();
    });

    $('#selectVisible').addEventListener('click', ()=>{
      filteredIdx.forEach(i => selected.add(i));
      renderRefined();
      $('#checkAll').checked = filteredIdx.length>0;
    });

    $('#clearSelection').addEventListener('click', ()=>{
      selected.clear();
      renderTable();
    });

    $('#exportCsv').addEventListener('click', ()=>{
      const chosen = [...selected].map(i=>rows[i]);
      if(!chosen.length){ alert('No selection.'); return; }
      const header = ['Name','NumLinesCovered','NumLinesUncovered','PercentCovered'];
      const lines = [header.join(',')].concat(chosen.map(r=>[
        `"${r.name.replace(/"/g,'""')}"`, r.covered, r.uncovered, r.pct.toFixed(2)
      ].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'refined_coverage.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
<script id="i18n-extra" type="application/json">{"en": {"apextestcoverageviewer_source": "Source:", "apextestcoverageviewer_paste_json_csv_tsv": "Paste (JSON / CSV / TSV)", "apextestcoverageviewer_ea0b5aac68": "Salesforce Tooling API (manual auth required)", "apextestcoverageviewer_load_data": "Load Data", "apextestcoverageviewer_sample": "Sample", "apextestcoverageviewer_copy": "Copy", "apextestcoverageviewer_fill_textarea": "Fill textarea", "apextestcoverageviewer_important": "Important:", "apextestcoverageviewer_run_tooling_query": "Run Tooling Query", "apextestcoverageviewer_all_results": "All results", "apextestcoverageviewer_select_visible": "Select visible", "apextestcoverageviewer_clear_selection": "Clear selection", "apextestcoverageviewer_covered": "% Covered", "apextestcoverageviewer_uncovered": "Uncovered", "apextestcoverageviewer_refined_table_selected": "Refined table (selected)", "apextestcoverageviewer_export_csv": "Export CSV", "apextestcoverageviewer_r_covered": "${r.covered}", "apextestcoverageviewer_r_uncovered": "${r.uncovered}", "apextestcoverageviewer_r_pct_tofixed_2": "${r.pct.toFixed(2)}%"}, "pt": {"apextestcoverageviewer_source": "Source:", "apextestcoverageviewer_paste_json_csv_tsv": "Paste (JSON / CSV / TSV)", "apextestcoverageviewer_ea0b5aac68": "Salesforce Tooling API (manual auth required)", "apextestcoverageviewer_load_data": "Load Data", "apextestcoverageviewer_sample": "Sample", "apextestcoverageviewer_copy": "Copy", "apextestcoverageviewer_fill_textarea": "Fill textarea", "apextestcoverageviewer_important": "Important:", "apextestcoverageviewer_run_tooling_query": "Run Tooling Query", "apextestcoverageviewer_all_results": "All results", "apextestcoverageviewer_select_visible": "Select visible", "apextestcoverageviewer_clear_selection": "Clear selection", "apextestcoverageviewer_covered": "% Covered", "apextestcoverageviewer_uncovered": "Uncovered", "apextestcoverageviewer_refined_table_selected": "Refined table (selected)", "apextestcoverageviewer_export_csv": "Export CSV", "apextestcoverageviewer_r_covered": "${r.covered}", "apextestcoverageviewer_r_uncovered": "${r.uncovered}", "apextestcoverageviewer_r_pct_tofixed_2": "${r.pct.toFixed(2)}%"}}</script>

<script>
(function(){
  const base = window.__i18nBase || {
    en: {
      title_portal: "Aplicativos Diversos",
      subtitle_portal: "Central portal with links to all apps in this repository.",
      open_app: "Open app",
      app_apex_title: "Apex Test Coverage Viewer",
      app_apex_desc: "Web tool to visualize Apex test coverage interactively and clearly.",
      app_gantt_title: "Gantt Chart Editor",
      app_gantt_desc: "Gantt chart editor (HTML + JavaScript) to plan and visualize tasks.",
      app_revise_title: "Revise.it",
      app_revise_desc: "Skeleton app to apply spaced repetition in daily life.",
      lang_en: "English",
      lang_pt: "Português",
      theme_dark: "Dark",
      theme_light: "Light"
    },
    pt: {
      title_portal: "Aplicativos Diversos",
      subtitle_portal: "Portal central com links para todos os apps deste repositório.",
      open_app: "Abrir app",
      app_apex_title: "Apex Test Coverage Viewer",
      app_apex_desc: "Ferramenta web para visualizar cobertura de testes Apex de forma interativa e clara.",
      app_gantt_title: "Gantt Chart Editor",
      app_gantt_desc: "Editor de gráficos de Gantt (HTML + JavaScript) para planejar e visualizar tarefas.",
      app_revise_title: "Revise.it",
      app_revise_desc: "Skeleton de aplicação para aplicar técnica de revisão espaçada no dia a dia.",
      lang_en: "English",
      lang_pt: "Português",
      theme_dark: "Escuro",
      theme_light: "Claro"
    }
  };

  function deepMerge(target, source){
    for (const k in source){
      if (source[k] && typeof source[k] === 'object' && !Array.isArray(source[k])){
        target[k] = target[k] || {};
        deepMerge(target[k], source[k]);
      } else {
        target[k] = source[k];
      }
    }
    return target;
  }

  const extraEl = document.getElementById('i18n-extra');
  if (extraEl){
    try {
      const extra = JSON.parse(extraEl.textContent || "{}");
      deepMerge(base, extra);
    } catch(e){}
  }

  let lang = localStorage.getItem('lang') || 'en';
  let theme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', theme);

  function applyI18n(root=document){
    root.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      const t = (base[lang] && base[lang][key]) || "";
      if (t) el.textContent = t;
    });
    document.querySelectorAll(".lang-toggle button").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.lang === lang);
    });
    const icon = document.querySelector(".theme-toggle .icon");
    if (icon){
      icon.innerHTML = theme === 'dark'
        ? '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/></svg>'
        : '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.8 1.8-1.8zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9-10v-2h-3v2h3zM6.76 19.16l-1.8 1.8 1.79 1.79 1.8-1.8-1.79-1.79zM11 1h2v3h-2V1zm7.07 3.05l-1.79 1.8 1.8 1.79 1.79-1.79-1.8-1.8zM4.22 10.99A7.78 7.78 0 1 0 12 4.22 7.78 7.78 0 0 0 4.22 11z"/></svg>';
    }
  }

  window.setLanguage = function(newLang){
    lang = newLang;
    localStorage.setItem('lang', lang);
    applyI18n();
  };
  window.toggleTheme = function(){
    theme = theme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', theme);
    document.documentElement.setAttribute('data-theme', theme);
    applyI18n();
  };

  document.addEventListener("DOMContentLoaded", applyI18n);
})();
</script>


<div class="footer"><span data-i18n="byline">By Dhalmeida</span> · <a href="mailto:diego.almeida@dhalmeida.com" data-i18n="contact">Contact</a></div>

</body>
</html>
