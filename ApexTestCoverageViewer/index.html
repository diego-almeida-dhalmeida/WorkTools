<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Apex Test Coverage Viewer</title>
  <link rel="stylesheet" href="../assets/css/styles.css?v=108">
  <style id="apex-scoped">
#apex-app{
      --bg:#0f1115; --panel:#151821; --muted:#9aa4b2; --text:#e8ecf1; --accent:#4aa3ff; --danger:#ff5b5b;
      --ok:#2fd47a; --border:#242939;
    }
#apex-app html,#apex-app body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
#apex-app h1{font-size:18px;margin:12px 0}
#apex-app .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
#apex-app .grid{display:grid;grid-template-columns:1.2fr 2fr;gap:16px}
#apex-app .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 20px rgba(0,0,0,.25)}
#apex-app .card header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
#apex-app .card header h2{margin:0;font-size:15px}
#apex-app .card .body{padding:12px 14px}
#apex-app textarea{width:100%;min-height:180px;resize:vertical;background:#0b0d12;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
#apex-app pre{background:#0b0f18;border:1px solid var(--border);border-radius:8px;padding:10px;overflow:auto}
#apex-app code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
#apex-app .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
#apex-app input[type="text"],#apex-app input[type="url"],#apex-app input[type="number"],#apex-app input[type="password"]{flex:1 1 220px;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#0b0d12;color:var(--text)}
#apex-app button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#101626;color:var(--text);cursor:pointer}
#apex-app button.primary{background:linear-gradient(180deg,#1a66ff,#1247b8);border-color:#0f2f7a}
#apex-app button.ghost{background:#101318}
#apex-app button:disabled{opacity:.6;cursor:not-allowed}
#apex-app select{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#0b0d12;color:var(--text)}
#apex-app table{width:100%;border-collapse:separate;border-spacing:0 8px}
#apex-app thead th{font-size:12px;color:var(--muted);text-align:left;padding:6px 10px}
#apex-app tbody tr{background:#0b0f18;border:1px solid var(--border);transition:transform .06s ease}
#apex-app tbody tr:hover{transform:translateY(-1px)}
#apex-app td{padding:10px}
#apex-app .num{font-variant-numeric:tabular-nums;text-align:right}
#apex-app .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#0f1320}
#apex-app .pct-ok .badge{background:rgba(47,212,122,.12);border-color:rgba(47,212,122,.35);color:var(--ok)}
#apex-app .pct-bad{outline:1px solid rgba(255,91,91,.35);background:linear-gradient(180deg,rgba(255,91,91,.08),transparent)}
#apex-app .pct-bad .badge{background:rgba(255,91,91,.12);border-color:rgba(255,91,91,.35);color:var(--danger)}
#apex-app .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
#apex-app .muted{color:var(--muted)}
#apex-app .sticky{position:sticky;top:0;background:var(--panel);z-index:2;border-bottom:1px solid var(--border)}
#apex-app .small{font-size:12px}
#apex-app .checkbox{width:18px;height:18px}
#apex-app .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b0f18}
#apex-app .totals{display:flex;gap:10px;flex-wrap:wrap}
#apex-app .totals .pill strong{color:var(--accent)}
#apex-app .hint{font-size:12px;color:var(--muted);margin-top:6px}
#apex-app .footer-note{margin-top:8px;color:var(--muted);font-size:12px}
#apex-app code.k{background:#0b0f18;border:1px solid var(--border);padding:1px 6px;border-radius:6px}
#apex-app .warn{color:#ffd479}
#apex-app .api-box{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#0b0f18}
#apex-app details.examples summary{cursor:pointer;user-select:none}
#apex-app .example-bar{display:flex;gap:8px;align-items:center;margin:8px 0}
  </style>
  
<style>#apex-app{position:relative!important;z-index:0!important}</style>

  <script>
  (function(){
    var v='v1.0.10';
    function forceBoot(){
      if (document.querySelector('header')) return;
      var h=document.createElement('header');
      h.innerHTML = '<div class="container" style="display:flex;align-items:center;gap:16px">'
        + '<div class="brand"><a href="../versions.html" class="badge">v1.0.10</a><span id="title">Various Apps</span></div>'
        + '<div class="controls"><div class="toolbar">'
        +   '<button class="iconbtn back-btn" data-action="back" title="Back"><span>←</span><span>Back</span></button>'
        +   '<a class="iconbtn" href="mailto:diego.almeida@dhalmeida.com" title="Contact"><span>Contact</span></a>'
        + '</div></div></div>';
      document.body.prepend(h);
      var f=document.createElement('footer');
      f.innerHTML = '<div class="container"><div class="footgrid"><div><h4>About</h4>'
        + '<div class="kvs"><div class="row"><span class="key">Version</span><span class="val"><a href="../versions.html">v1.0.10</a></span></div></div></div>'
        + '<div><h4>Contact</h4><div class="kvs"><div class="row"><span class="key">Email</span><span class="val"><a href="mailto:diego.almeida@dhalmeida.com">diego.almeida@dhalmeida.com</a></span></div></div></div></div>'
        + '<div class="copyright">© <span class="sig">By Dhalmeida</span>. All rights reserved.</div></div>';
      document.body.appendChild(f);
      var backBtn = h.querySelector('.back-btn');
      if(backBtn){ backBtn.addEventListener('click', function(){ try{ if(document.referrer && document.referrer!==location.href){ history.back(); return; } }catch(e){} location.href='../index.html'; }); }
    }
    var s=document.createElement('script');
    s.src='../assets/js/app.js?v=110'; s.defer=true;
    s.onload=function(){ if(window.WT && WT.init){ try{ WT.init(); }catch(e){} } else { forceBoot(); } };
    s.onerror=function(){ forceBoot(); };
    document.head.appendChild(s);
  })();
  </script>


  <!-- v1.0.10 chrome loader (force parent assets) -->
  <style>header{position:sticky;top:0;z-index:2147483000}footer{position:relative;z-index:2147482000}body>main{min-height:calc(100vh - 56px - 64px)}</style>
  <script>
  (function(){
    function boot(){
      if (window.WT && WT.init){ try{ WT.init(); }catch(e){} return; }
      // emergency header/footer
      if (document.querySelector('header')) return;
      var h=document.createElement('header');
      h.innerHTML='<div class="container" style="display:flex;align-items:center;gap:16px">'
        +'<div class="brand"><a href="../versions.html" class="badge">v1.0.10</a><span id="title">Various Apps</span></div>'
        +'<div class="controls"><div class="toolbar">'
        +'<button class="iconbtn back-btn" data-action="back" title="Back"><span>←</span><span>Back</span></button>'
        +'<a class="iconbtn" href="mailto:diego.almeida@dhalmeida.com" title="Contact"><span>Contact</span></a>'
        +'</div></div></div>';
      document.body.prepend(h);
      var f=document.createElement('footer');
      f.innerHTML='<div class="container"><div class="copyright">© <span class="sig">By Dhalmeida</span>. All rights reserved.</div></div>';
      document.body.appendChild(f);
      var b=h.querySelector('.back-btn'); if(b){ b.addEventListener('click', function(){ location.href='../index.html'; }); }
    }
    var s=document.createElement('script'); s.defer=true; s.src='../assets/js/app.js?v=110';
    s.onload=boot; s.onerror=boot; document.head.appendChild(s);
    setTimeout(boot, 300); // last resort
  })();
  </script>



  <!-- v1.0.12 loader & logs -->
  <script>
  (function(){
    const TAG='WTv1.0.12';
    function log(){ try{ console.log('[%s:apex]', TAG, ...arguments); }catch(e){} }
    function warn(){ try{ console.warn('[%s:apex]', TAG, ...arguments); }catch(e){} }
    function err(){ try{ console.error('[%s:apex]', TAG, ...arguments); }catch(e){} }

    log('head:loader:start', {url: location.href, ready: document.readyState});

    function ensureChrome(reason){
      if (document.querySelector('header')){ log('ensureChrome:exists', reason||''); return; }
      warn('ensureChrome:inject', reason||'');
      var h=document.createElement('header');
      h.innerHTML='<div class="container" style="display:flex;align-items:center;gap:16px">'
        +'<div class="brand"><a href="../versions.html" class="badge">v1.0.12</a><span id="title">Various Apps</span></div>'
        +'<div class="controls"><div class="toolbar">'
        +'<button class="iconbtn back-btn" data-action="back" title="Back"><span>←</span><span>Back</span></button>'
        +'<a class="iconbtn" href="mailto:diego.almeida@dhalmeida.com" title="Contact"><span>Contact</span></a>'
        +'</div></div></div>';
      document.body.prepend(h);
      var f=document.createElement('footer');
      f.innerHTML='<div class="container"><div class="copyright">© <span class="sig">By Dhalmeida</span>. All rights reserved.</div></div>';
      document.body.appendChild(f);
      var b=h.querySelector('.back-btn'); if(b){ b.addEventListener('click', function(){ location.href='../index.html'; }); }
      log('ensureChrome:done', {hasHeader: !!document.querySelector('header'), hasFooter: !!document.querySelector('footer')});
    }

    function boot(){
      if (window.WT && WT.init){
        log('boot:WT.init available');
        try{ WT.init(); }catch(e){ err('boot:WT.init error', e); }
        if (!document.querySelector('header')) ensureChrome('WT.init returned without header');
        return;
      }
      ensureChrome('WT.init not available');
    }

    // Force parent assets
    var s=document.createElement('script'); s.defer=true; s.src='../assets/js/app.js?v=112';
    s.onload=function(){ log('loader:onload', s.src); boot(); };
    s.onerror=function(){ err('loader:onerror', s.src); boot(); };
    document.head.appendChild(s);

    // Last resort fallback
    setTimeout(function(){ warn('loader:timeout fallback'); boot(); }, 500);
  })();
  </script>

<style id="v113-visual">header{background:rgba(0,0,0,.6)!important} body>main{display:block!important}</style>
</head>
<body>
  <main>
    <div id="apex-app">
<div class="wrap">
    <h1>Apex Test Coverage Viewer</h1>

    <div class="grid">
      <!-- Input panel -->
      <section class="card">
        <header><h2>Data input</h2></header>
        <div class="body">
          <div class="row">
            <label for="source">Source:</label>
            <select id="source">
              <option value="paste" selected>Paste (JSON / CSV / TSV)</option>
              <option value="api">Salesforce Tooling API (manual auth required)</option>
            </select>
          </div>

          <!-- Paste mode -->
          <div id="pasteBox">
            <div class="row">
              <button id="btnLoad" class="primary">Load Data</button>
              <button id="btnSample" class="ghost">Sample</button>
              <span class="muted small">Expected fields: <code class="k">ApexClassOrTrigger.Name</code>, <code class="k">NumLinesCovered</code>, <code class="k">NumLinesUncovered</code></span>
            </div>
            <textarea id="inputRaw" placeholder='Paste JSON, CSV, or TSV here.'></textarea>

            <!-- Examples block with Tooling API SOQL -->
            <details class="examples" style="margin-top:10px">
              <summary>Input examples and Tooling API SOQL</summary>

              <div class="example-bar">
                <strong>JSON</strong>
                <button class="ghost" data-copy="#ex-json">Copy</button>
                <button class="ghost" data-fill="#ex-json">Fill textarea</button>
              </div>
              <pre id="ex-json"><code>[
  {"ApexClassOrTrigger.Name":"AccountTrigger","NumLinesCovered":5,"NumLinesUncovered":1},
  {"ApexClassOrTrigger.Name":"AccountUtils","NumLinesCovered":92,"NumLinesUncovered":446}
]</code></pre>

              <div class="example-bar">
                <strong>CSV</strong>
                <button class="ghost" data-copy="#ex-csv">Copy</button>
                <button class="ghost" data-fill="#ex-csv">Fill textarea</button>
              </div>
              <pre id="ex-csv"><code>ApexClassOrTrigger.Name,NumLinesCovered,NumLinesUncovered
AccountTrigger,5,1
AccountUtils,92,446</code></pre>

              <div class="example-bar">
                <strong>TSV</strong>
                <button class="ghost" data-copy="#ex-tsv">Copy</button>
                <button class="ghost" data-fill="#ex-tsv">Fill textarea</button>
              </div>
              <pre id="ex-tsv"><code>ApexClassOrTrigger.Name	NumLinesCovered	NumLinesUncovered
AccountTrigger	5	1
AccountUtils	92	446</code></pre>

              <div class="example-bar">
                <strong>Tooling API SOQL</strong>
                <button class="ghost" data-copy="#ex-soql">Copy</button>
              </div>
              <pre id="ex-soql"><code>SELECT ApexClassOrTrigger.Name, NumLinesCovered, NumLinesUncovered
FROM ApexCodeCoverageAggregate</code></pre>

              <div class="hint">
                <span class="warn">Important:</span> run the SOQL in **Tooling API** context and paste the exported result (JSON/CSV/TSV) above,
                or switch to the Tooling API mode and provide a valid token. Example CLI:
                <code class="k">sfdx force:data:soql:query -t -q "SELECT ApexClassOrTrigger.Name, NumLinesCovered, NumLinesUncovered FROM ApexCodeCoverageAggregate" --json</code>
              </div>
            </details>
          </div>

          <!-- API mode -->
          <div id="apiBox" class="api-box" style="display:none">
            <div class="row">
              <input id="instanceUrl" type="url" placeholder="Instance URL (e.g., https://yourDomain.my.salesforce.com)" />
            </div>
            <div class="row">
              <input id="apiVersion" type="number" min="30" max="99" step="1" value="61" style="max-width:140px" />
              <input id="accessToken" type="password" placeholder="Access Token (Bearer)" />
            </div>
            <div class="row">
              <input id="soql" type="text" value="SELECT ApexClassOrTrigger.Name, NumLinesCovered, NumLinesUncovered FROM ApexCodeCoverageAggregate" />
              <button id="btnRun" class="primary">Run Tooling Query</button>
            </div>
            <div class="hint">
              <span class="warn">Important:</span> you must provide a valid token and have CORS allowed for your origin.
              This runs a GET to <code class="k">/services/data/vXX.X/tooling/query/?q=...</code> with <code class="k">Authorization: Bearer &lt;token&gt;</code>.
            </div>
          </div>

          <div id="err" class="hint"></div>
        </div>
      </section>

      <!-- Main table -->
      <section class="card">
        <header class="sticky">
          <h2 style="flex:1">All results</h2>
          <div class="toolbar">
            <input type="text" id="search" placeholder="Search by name..." />
            <button id="selectVisible" class="ghost">Select visible</button>
            <button id="clearSelection" class="ghost">Clear selection</button>
          </div>
        </header>
        <div class="body">
          <div class="totals" id="totals"></div>
          <table id="mainTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="checkAll" class="checkbox" title="Select all"/></th>
                <th>Class/Trigger</th>
                <th class="num">Covered</th>
                <th class="num">Uncovered</th>
                <th class="num">% Covered</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="footer-note">Rows with coverage below 80% are highlighted in red.</div>
        </div>
      </section>
    </div>

    <!-- Refined table -->
    <section class="card" style="margin-top:16px">
      <header>
        <h2 style="flex:1">Refined table (selected)</h2>
        <div class="toolbar">
          <button id="exportCsv" class="ghost">Export CSV</button>
          <span id="refinedTotals" class="muted small"></span>
        </div>
      </header>
      <div class="body">
        <table id="refinedTable">
          <thead>
            <tr>
              <th>Class/Trigger</th>
              <th class="num">Covered</th>
              <th class="num">Uncovered</th>
              <th class="num">% Covered</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>
    </div>
  </main>
  


  <!-- v1.0.16 Apex sample fallback -->
  <script>
  (function(){
    try{
      var sampleData = "ApexClassOrTrigger,NumLinesCovered,NumLinesUncovered\nExampleClass,80,20\nExampleTrigger,30,5\n";
      function attach(){
        var btn = document.querySelector('[data-action="sample"], button#sample, .sample-btn');
        var ta  = document.querySelector('textarea, #input, #data');
        if (!btn || !ta) return false;
        if (!btn._wtBound){
          btn.addEventListener('click', function(ev){ try{ ev.preventDefault(); }catch(_){}
            ta.value = sampleData;
            var inputEvt;
            try{ inputEvt = new Event('input'); }catch(_){ inputEvt = document.createEvent('Event'); inputEvt.initEvent('input', true, true); }
            ta.dispatchEvent(inputEvt);
            console.log('[WTv1.0.16:apex] sample fallback filled');
          });
          btn._wtBound = true;
        }
        return true;
      }
      if (!attach()){ document.addEventListener('DOMContentLoaded', attach); setTimeout(attach, 500); }
    }catch(e){ try{ console.error(e); }catch(_){ } }
  })();
  </script>


  
  
  
  
  
  
  
  <!-- v1.0.25 apex: unified fallback + threshold/i18n + logs -->
  <style>
    /* numeric alignment */
    #mainTable th:nth-child(3), #mainTable th:nth-child(4), #mainTable th:nth-child(5),
    #mainTable td.num, #refinedTable th:nth-child(2), #refinedTable th:nth-child(3), #refinedTable th:nth-child(4),
    #refinedTable td.num { text-align: right; }
    /* row highlight */
.wt-row-bad{ background: linear-gradient(180deg, rgba(0,0,0,0.00) 0%, rgba(255,23,68,.28) 100%) !important; outline: none !important; }
:is(html.dark, .dark) .wt-row-bad{ background: linear-gradient(180deg, rgba(0,0,0,0.00) 0%, rgba(255,23,68,.38) 100%) !important; outline: none !important; }
.wt-row-bad > td{ border-color: transparent !important; }
/* percent pill */
.wt-pill{display:inline-inline-block; padding:.2rem .7rem; border-radius:9999px; font-size:.86rem; line-height:1; font-weight:700; letter-spacing:.2px; border:1px solid transparent;}
.wt-pill.wt-good{ background:#1ec46b; color:#08140c; border-color:#0e6e3c33; }
.wt-pill.wt-bad{ background:#ff1744; color:#140409; border-color:#7f0b221f; }
:is(html.dark, .dark) .wt-pill.wt-good{ background:#1de9b6; color:#03120e; border-color:#0a5f4a44; }
:is(html.dark, .dark) .wt-pill.wt-bad{ background:#ff1744; color:#140409; border-color:#8d0b263a; }
/* controls */
    .wt-controls { display:flex; align-items:center; gap:8px; margin:8px 0 4px 0; font-size: .95rem; opacity:.95;}
    .wt-controls label{opacity:.9}
    .wt-controls select{background:transparent; color:inherit; border:1px solid currentColor; padding:4px 8px; border-radius:6px;}
  </style>
  <script>
  (function(){
    var TAG='WTv1.0.25:apex';
    function L(){ try{ var a=['['+TAG+']']; for(var i=0;i<arguments.length;i++) a.push(arguments[i]); console.log.apply(console,a);}catch(e){} }
    function W(){ try{ var a=['['+TAG+':WARN]']; for(var i=0;i<arguments.length;i++) a.push(arguments[i]); console.warn.apply(console,a);}catch(e){} }
    function E(){ try{ var a=['['+TAG+':ERR]']; for(var i=0;i<arguments.length;i++) a.push(arguments[i]); console.error.apply(console,a);}catch(e){} }

    function qs(s,r){ return (r||document).querySelector(s); }
    function qsa(s,r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
    function t(el){ return (el && (el.textContent||'').trim()) || ''; }

    // ==== i18n + threshold ====
    var LS_KEY='wt_cov_threshold';
    var threshold = Number(localStorage.getItem(LS_KEY)||80);
    var STR={
      en:{ thr:'Coverage threshold', thrSuffix:'%', hint:'Rows below the threshold are highlighted.' },
      pt:{ thr:'Limite de cobertura', thrSuffix:'%', hint:'Linhas abaixo do limite ficam destacadas.' }
    };
    function getLang(){
      var lang = document.documentElement.getAttribute('lang')||'en';
      var chip = qs('#wt-lang-current'); if (chip && chip.textContent.trim().toLowerCase()==='pt') lang='pt';
      return (lang==='pt')?'pt':'en';
    }
    function T(k){ var l=getLang(); return (STR[l]&&STR[l][k])||STR.en[k]||k; }
    function formatPct(v){ var n = Number(v||0); return n.toFixed(1)+'%'; }
    function setThreshold(v){ threshold = Number(v||80); localStorage.setItem(LS_KEY, threshold); applyRowStyles(); }

    function ensureControls(){
      if (qs('#wt-threshold')) return;
      var host = (function(){ var mt = qs('#mainTable'); if (mt) return mt.parentElement; return qs('#apex-app')||document.body; })();
      var div = document.createElement('div'); div.className='wt-controls'; div.id='wt-threshold';
      var sel = document.createElement('select'); sel.id='wt-thr-sel';
      [75,80,85,90,95].forEach(function(v){ var opt=document.createElement('option'); opt.value=v; opt.textContent=v+STR.en.thrSuffix; sel.appendChild(opt); });
      sel.value = String(threshold);
      sel.addEventListener('change', function(e){ setThreshold(e.target.value); });
      var label = document.createElement('label'); label.setAttribute('for','wt-thr-sel'); label.textContent=T('thr');
      var hint = document.createElement('span'); hint.style.opacity='.7'; hint.style.marginLeft='6px'; hint.textContent=T('hint');
      div.appendChild(label); div.appendChild(sel); div.appendChild(hint);
      host.insertBefore(div, host.firstChild);
      L('controls:mounted', {threshold: threshold});
    }

    function applyRowStyles(){
  qsa('#mainTable tbody tr').forEach(function(tr){
    var pctCell = tr.querySelector('td:last-child'); if(!pctCell) return;
    var span = pctCell.querySelector('.wt-pill');
    var pctText = span ? span.textContent : (pctCell.textContent||'');
    var pct = parseFloat((pctText||'').replace('%','').trim());
    if (isNaN(pct)) { var c = tr.querySelector('input.wt-sel'); if (c && c.dataset && c.dataset.pct) pct = Number(c.dataset.pct); }
    if (pct < threshold) { tr.classList.add('wt-row-bad'); if(span){ span.classList.add('wt-bad'); span.classList.remove('wt-good'); } }
    else { tr.classList.remove('wt-row-bad'); if(span){ span.classList.remove('wt-bad'); span.classList.add('wt-good'); } }
  });
  qsa('#refinedTable tbody tr').forEach(function(tr){
    var pctCell = tr.querySelector('td:last-child'); if(!pctCell) return;
    var span = pctCell.querySelector('.wt-pill');
    var pctText = span ? span.textContent : (pctCell.textContent||'');
    var pct = parseFloat((pctText||'').replace('%','').trim());
    if (pct < threshold) { tr.classList.add('wt-row-bad'); if(span){ span.classList.add('wt-bad'); span.classList.remove('wt-good'); } }
    else { tr.classList.remove('wt-row-bad'); if(span){ span.classList.remove('wt-bad'); span.classList.add('wt-good'); } }
  });
  L('styles:applied', {threshold:threshold});
}

    function patchPctFormatting(){
      qsa('#mainTable tbody tr, #refinedTable tbody tr').forEach(function(tr){
        var c = tr.querySelector('td:last-child'); if(!c) return;
        var txt = (c.textContent||'').trim();
        if (txt && txt.indexOf('%')<0 && !isNaN(parseFloat(txt))) c.textContent = formatPct(parseFloat(txt));
      });
    }

    function observeTables(){
  var obs = new MutationObserver(function(){
    patchPctFormatting(); applyRowStyles();
  });
  var mt = qs('#mainTable tbody'); if (mt) obs.observe(mt, {childList:true, subtree:true, characterData:true});
  var rt = qs('#refinedTable tbody'); if (rt) obs.observe(rt, {childList:true, subtree:true, characterData:true});
  patchPctFormatting(); applyRowStyles();
}

// search binding for mainTable
function bindSearch(){
  if (bindSearch._bound) return;
  var cand = qs('#apex-app input[type=search]')
         || qsa('#apex-app input').find(function(i){ var p=(i.getAttribute('placeholder')||'').toLowerCase(); return p.indexOf('search')>=0 || p.indexOf('name')>=0; })
         || qs('input[type=search]')
         || qsa('input').find(function(i){ var p=(i.getAttribute('placeholder')||'').toLowerCase(); return p.indexOf('search')>=0; });
  if(!cand){ W('search:notFound'); return; }
  var tmr=null; var last='';
  cand.addEventListener('input', function(){
    var q=(cand.value||'').toLowerCase().trim(); if(q===last) return; last=q; clearTimeout(tmr);
    tmr=setTimeout(function(){
      var rows=qsa('#mainTable tbody tr');
      rows.forEach(function(tr){
        var nameCell = tr.children[1]; var txt = nameCell ? (nameCell.textContent||'').toLowerCase() : '';
        tr.style.display = (!q || txt.indexOf(q)>=0) ? '' : 'none';
      });
      L('search:filter', {q:q, rows:rows.length});
    }, 80);
  });
  bindSearch._bound=true; L('search:bound');
}

    // ==== fallback integration (from v1.0.22) ====
    // anonymized sample
    var sampleObj=[
      {"ApexClassOrTrigger.Name":"AlphaTrigger","NumLinesCovered":5,"NumLinesUncovered":1},
      {"ApexClassOrTrigger.Name":"BetaController","NumLinesCovered":137,"NumLinesUncovered":16},
      {"ApexClassOrTrigger.Name":"GammaApp","NumLinesCovered":31,"NumLinesUncovered":11},
      {"ApexClassOrTrigger.Name":"DeltaUtils","NumLinesCovered":92,"NumLinesUncovered":446},
      {"ApexClassOrTrigger.Name":"EpsilonHours","NumLinesCovered":39,"NumLinesUncovered":1},
      {"ApexClassOrTrigger.Name":"OmegaHandler","NumLinesCovered":44,"NumLinesUncovered":59}
    ];
    var sampleJSON=JSON.stringify(sampleObj,null,2);

    function sanitizeText(v){ if(!v) return ''; v=v.replace(/\r\n?/g,'\n').replace(/\\n/g,'\n').replace(/\\t/g,'\t').replace(/^\ufeff/,''); return v.trim(); }
    function tryParseJSON(v){
      var s=sanitizeText(v);
      try{ return JSON.parse(s);}catch(e1){
        try{ if(/^".*"$/.test(s)){ s=s.slice(1,-1).replace(/\\"/g,'"'); return JSON.parse(s); } }catch(e2){}
        E('json:parse fail'); return null;
      }
    }
    function parseDelim(text, sep){
      var rows=[], r=[], inQ=false, cur='';
      for(var i=0;i<text.length;i++){ var ch=text[i],n=text[i+1];
        if(ch=='"'){ if(inQ&&n=='"'){ cur+='"'; i++; } else inQ=!inQ; }
        else if(ch==sep && !inQ){ r.push(cur); cur=''; }
        else if((ch=='\n'||ch=='\r') && !inQ){ if(cur!==''||r.length){ r.push(cur); rows.push(r); r=[]; cur=''; } }
        else cur+=ch;
      }
      if(cur!==''||r.length){ r.push(cur); rows.push(r); }
      return rows;
    }
    function normalizeFromJSON(arr){
      if(!Array.isArray(arr)) return [];
      return arr.map(function(it){
        var name=(it['ApexClassOrTrigger.Name']||(it.ApexClassOrTrigger&&it.ApexClassOrTrigger.Name)||it.Name||'').toString();
        var cov=Number(it.NumLinesCovered||0), unc=Number(it.NumLinesUncovered||0);
        var pct=(cov+unc>0)? Math.round(cov*1000/(cov+unc))/10 : 0;
        return {name:name, covered:cov, uncovered:unc, pct:pct};
      });
    }
    function normalizeFromRows(rows){
      if(!rows||!rows.length) return [];
      var hdr=rows[0].map(function(h){ return (h||'').toLowerCase(); });
      function idx(k){ var i=hdr.indexOf(k); if(i>=0) return i; for(var j=0;j<hdr.length;j++){ if(hdr[j].indexOf(k)>=0) return j; } return -1; }
      var iName=idx('apexclassortrigger.name'); if(iName<0) iName=idx('apexclassortrigger'); if(iName<0) iName=idx('name');
      var iCov=idx('numlinescovered'), iUnc=idx('numlinesuncovered');
      var out=[]; for(var i=1;i<rows.length;i++){ var r=rows[i]; if(!r||!r.length) continue;
        var name=(r[iName]||'').toString(), cov=Number(r[iCov]||0), unc=Number(r[iUnc]||0);
        var pct=(cov+unc>0)? Math.round(cov*1000/(cov+unc))/10 : 0;
        out.push({name:name, covered:cov, uncovered:unc, pct:pct});
      } return out;
    }

    function getTbody(id){ var el=qs('#'+id+' tbody'); return el||null; }

    function renderMain(items){
      var tb=getTbody('mainTable');
      if(!tb){ W('mainTable tbody not found'); return false; }
      tb.innerHTML='';
      items.forEach(function(it){
        var tr=document.createElement('tr');
        var pctClass = (it.pct<80)? 'wt-row-bad' : '';
        tr.innerHTML = '<td><input type="checkbox" class="wt-sel" data-name="'+it.name.replace(/"/g,'&quot;')+'" data-covered="'+it.covered+'" data-uncovered="'+it.uncovered+'" data-pct="'+it.pct+'"></td>'
                     + '<td>'+it.name+'</td>'
                     + '<td class="num">'+it.covered+'</td>'
                     + '<td class="num">'+it.uncovered+'</td>'
                     + '<td class="num '+pctClass+'">'+formatPct(it.pct)+'</td>';
        tb.appendChild(tr);
      });
      document.dispatchEvent(new CustomEvent('wt-apex-render'));
      L('render:main', {rows: items.length});
      return true;
    }

    function renderRefinedFromSelection(){
      var tb = getTbody('refinedTable'); if(!tb){ W('refinedTable tbody not found'); return; }
      tb.innerHTML='';
      var selected = qsa('#mainTable .wt-sel:checked').map(function(c){
        return { name:c.dataset.name, covered:Number(c.dataset.covered), uncovered:Number(c.dataset.uncovered), pct:Number(c.dataset.pct) };
      });
      selected.forEach(function(it){
        var pctClass = (it.pct<threshold)? 'wt-row-bad' : '';
        var tr=document.createElement('tr');
        tr.innerHTML = '<td>'+it.name+'</td><td class="num">'+it.covered+'</td><td class="num">'+it.uncovered+'</td><td class="num '+pctClass+'">'+formatPct(it.pct)+'</td>';
        tb.appendChild(tr);
      });
      document.dispatchEvent(new CustomEvent('wt-apex-render'));
      L('render:refined', {rows:selected.length});
      // bind Export CSV to selected dataset
      var btn = qsa('#apex-app button, #apex-app a').find(function(b){ var t=(b.textContent||'').toLowerCase(); return t.indexOf('export')>=0 && t.indexOf('csv')>=0; });
      if(btn && !btn._wtCsv25){
        btn.addEventListener('click', function(ev){
          try{ ev.preventDefault(); }catch(_){}
          var lines=['Class/Trigger,Covered,Uncovered,% Covered'].concat(selected.map(function(it){ return [it.name,it.covered,it.uncovered,it.pct.toFixed(1)+'%'].join(','); }));
          var blob=new Blob([lines.join('\\n')], {type:'text/csv'}); var a=document.createElement('a'); a.download='coverage.csv'; a.href=URL.createObjectURL(blob); a.click();
        });
        btn._wtCsv25=true; L('exportCSV:bound:selected', {rows:selected.length});
      }
    }

    function wireSelectionSync(){
      var main = qs('#mainTable'); if(!main) return;
      if(main._wtSelBound) return;
      main.addEventListener('change', function(e){
        var t=e.target; if(!t.classList.contains('wt-sel')) return;
        renderRefinedFromSelection();
      });
      main._wtSelBound=true; L('selection:bound');
    }

    function computeBadges(items){
      var cov=0, unc=0; items.forEach(function(it){ cov+=it.covered; unc+=it.uncovered; });
      var total=cov+unc, pct=(total>0? Math.round(cov*1000/total)/10 : 0);
      function set(id, text){ var el=qs('#'+id); if(el) el.textContent=text; }
      set('metricTotal', total);
      set('metricCovered', cov);
      set('metricUncovered', unc);
      set('metricOverall', pct+'%');
      L('metrics', {total:total,cov:cov,unc:unc,pct:pct});
    }

    function runFromTextarea(){
      var ta = qs('#inputRaw, #apex-app textarea, textarea'); if(!ta){ W('no textarea'); return; }
      var raw = sanitizeText(ta.value||''); if(!raw){ W('textarea empty'); return; }
      var items=null;
      if (raw.trim()[0]==='['){ var a=tryParseJSON(raw); if(a) items = normalizeFromJSON(a); }
      if (!items){ if (raw.indexOf('\\t')>=0) items = normalizeFromRows(parseDelim(raw,'\\t')); else items = normalizeFromRows(parseDelim(raw,',')); }
      items = items||[];
      computeBadges(items);
      if (!renderMain(items)){
        var host = qs('#wt-fallback-results') || (function(){ var d=document.createElement('div'); d.id='wt-fallback-results'; d.style.margin='16px'; return (qs('#apex-app')||document.body).appendChild(d); })();
        host.innerHTML = '<pre>'+JSON.stringify(items,null,2)+'</pre>';
        L('fallback:dump', {rows: items.length});
      } else {
        wireSelectionSync();
        renderRefinedFromSelection();
      }
    }

    function forcePasteSource(){
      var s = qs('#source'); if (!s) return;
      var opt = qsa('option', s).find(function(o){ return /paste/i.test(o.value) || /paste/i.test(o.textContent||''); });
      if (opt){ s.value = opt.value; try{ s.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){ var ev=document.createEvent('Event'); ev.initEvent('change', true, true); s.dispatchEvent(ev); } }
      L('forcePasteSource', {value: s.value});
    }

    function attach(){
      var root = qs('#apex-app') || document.body;
      L('attach', {buttons:qsa('button',root).length,selects:qsa('select',root).length,inputs:qsa('input,textarea',root).length});
      var btnSample = qs('#btnSample, [data-action=sample]');
      var btnLoad   = qs('#btnLoad, [data-action=load]');
      var ta        = qs('#inputRaw, #apex-app textarea, textarea');

      if (btnSample && !btnSample._wt25){
        btnSample.addEventListener('click', function(ev){
          try{ ev.preventDefault(); }catch(_){}
          forcePasteSource();
          if (ta){ ta.value = sampleJSON; try{ ta.dispatchEvent(new Event('input',{bubbles:true})); }catch(_){ var ev=document.createEvent('Event'); ev.initEvent('input', true, true); ta.dispatchEvent(ev);} }
          if (btnLoad){ try{ btnLoad.click(); }catch(_){ runFromTextarea(); } } else { runFromTextarea(); }
          L('sample:json-filled');
        });
        btnSample._wt25=true; L('sample:bound25');
      }
      if (btnLoad && !btnLoad._wt25){
        btnLoad.addEventListener('click', function(){ setTimeout(runFromTextarea, 120); });
        btnLoad._wt25=true; L('load:bound25');
      }
    }

    function init(){ ensureControls(); observeTables(); attach(); bindSearch(); }
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
    setTimeout(init, 500);
  })();
  </script>

</body>
</html>